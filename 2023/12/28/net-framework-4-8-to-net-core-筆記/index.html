<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/gg.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/gg.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/gg.png">
  <link rel="mask-icon" href="/images/gg.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-171640966-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-171640966-1');
</script>

<style>
    @font-face {
        /* font-family: "JasonHandwriting1-Regular"; */
/*
        src: url(https://cdn.jsdelivr.net/gh/max32002/JasonHandWritingFonts@20210716/webfont/JasonHandwriting1-Regular.woff2) format("woff2"), url(https://cdn.jsdelivr.net/gh/max32002/JasonHandWritingFonts@20210716/webfont/JasonHandwriting1-Regular.woff) format("woff");
		*/

        font-family: "俐方體11號";
        src: url(/fonts/Cubic_11_1.000_R.woff) format("woff")
    }
</style>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.blog.lasai.com.tw","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="&amp;nbsp;">
<meta property="og:type" content="article">
<meta property="og:title" content=".net framework 4.8 to .net core 筆記">
<meta property="og:url" content="https://www.blog.lasai.com.tw/2023/12/28/net-framework-4-8-to-net-core-%E7%AD%86%E8%A8%98/index.html">
<meta property="og:site_name" content="🌹 喇賽的人 Blog 🌹">
<meta property="og:description" content="&amp;nbsp;">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2023-12-28T12:01:34.000Z">
<meta property="article:modified_time" content="2025-02-19T09:29:19.093Z">
<meta property="article:author" content="🌹 喇賽人 🌹">
<meta property="article:tag" content="c#">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://www.blog.lasai.com.tw/2023/12/28/net-framework-4-8-to-net-core-%E7%AD%86%E8%A8%98/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>.net framework 4.8 to .net core 筆記 | 🌹 喇賽的人 Blog 🌹</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-171640966-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-171640966-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <!-- google ad -->
  <!--
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1069539516107706"
     crossorigin="anonymous"></script>
  -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!--
  <div class="spell" ></div>
  <div class="ghost" style="display: none;"></div>
  <div class="noise"></div>
  <div class="noise2"></div>
  -->


  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">🌹 喇賽的人 Blog 🌹</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">🌹 喇低喇賽 🌹</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>真喇賽</a>

  </li>
        <li class="menu-item menu-item-map">

    <a href="/map/" rel="section"><i class="fa fa-map fa-fw"></i>喇賽人的奇怪美食地圖</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>關於喇賽人</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>喇賽的標籤</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>喇賽亂寫</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://www.blog.lasai.com.tw/2023/12/28/net-framework-4-8-to-net-core-%E7%AD%86%E8%A8%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="🌹 喇賽人 🌹">
      <meta itemprop="description" content="🌹 喇賽人的 Blog 🌹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="🌹 喇賽的人 Blog 🌹">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          .net framework 4.8 to .net core 筆記
        </h1>

        <div class="post-meta">
		
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">亂寫於</span>

              <time title="亂入時間：2023-12-28 20:01:34" itemprop="dateCreated datePublished" datetime="2023-12-28T20:01:34+08:00">2023-12-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2025-02-19 17:29:19" itemprop="dateModified" datetime="2025-02-19T17:29:19+08:00">2025-02-19</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/2023/12/28/net-framework-4-8-to-net-core-%E7%AD%86%E8%A8%98/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2023/12/28/net-framework-4-8-to-net-core-筆記/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="廢話字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">廢話字數：</span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="所需傷眼時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">所需傷眼時間 &asymp;</span>
              <span>16 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>&nbsp;</p>
<a id="more"></a>

<p>這是我工作上升級舊版 <code>web api</code> <code>排程程式</code> 及 <code>底層類別</code> 遇到的相關解法 , 以 cookbook 的方式記錄下</p>
<h2 id="ef-core"><a href="#ef-core" class="headerlink" title="ef core"></a>ef core</h2><h3 id="ef-core-The-entity-type-‘IdentityUserLogin‘-requires-a-primary-key-to-be-defined"><a href="#ef-core-The-entity-type-‘IdentityUserLogin‘-requires-a-primary-key-to-be-defined" class="headerlink" title="ef core The entity type ‘IdentityUserLogin‘ requires a primary key to be defined"></a>ef core The entity type ‘IdentityUserLogin<string>‘ requires a primary key to be defined</h3><p>可以參考<a href="https://stackoverflow.com/questions/40703615/the-entity-type-identityuserloginstring-requires-a-primary-key-to-be-defined" target="_blank" rel="noopener">這裡</a></p>
<p>因為有使用到 <code>IdentityDbContext&lt;MyUser&gt;</code> 所以在 <code>OnModelCreating</code> 先呼叫</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">base</span>.OnModelCreating(modelBuilder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-DbContext-Include-Roles"><a href="#ef-core-DbContext-Include-Roles" class="headerlink" title="ef core DbContext Include Roles"></a>ef core DbContext Include Roles</h3><p>這個問題疑似要自己定義 Roles 沒定義這樣寫的話會噴紅字</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.Users.Include(x =&gt; x.Roles);</span><br></pre></td></tr></table></figure>

<p>可以參考<a href="https://stackoverflow.com/questions/47767267/ef-core-2-how-to-include-roles-navigation-property-on-identityuser" target="_blank" rel="noopener">這篇</a></p>
<p>解法如下 , 這裡注意到使用 <code>IdentityUser</code></p>
<p>需要安裝套件 <code>Microsoft.AspNetCore.Identity.EntityFrameworkCore</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyUser</span> : <span class="title">IdentityUser</span>&#123;</span><br><span class="line">    <span class="comment">//要自己手動加入</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Navigation property for the roles this user belongs to.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> ICollection&lt;IdentityUserRole&lt;<span class="keyword">string</span>&gt;&gt; Roles &#123; <span class="keyword">get</span>; &#125; = <span class="keyword">new</span> List&lt;IdentityUserRole&lt;<span class="keyword">string</span>&gt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-new-DbContext"><a href="#ef-core-new-DbContext" class="headerlink" title="ef core new DbContext"></a>ef core new DbContext</h3><p>如果在以前的類別裡面有直接 <code>new DbContext</code> 這樣會噴 Erorr</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> YourrDbContext())</span><br></pre></td></tr></table></figure>

<p>不想要注入的話可以參考以下這個方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> optionsBuilder = <span class="keyword">new</span> DbContextOptionsBuilder&lt;YourrDbContext&gt;();</span><br><span class="line">optionsBuilder.UseSqlServer(GetConnectionString());</span><br><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> db = <span class="keyword">new</span> YourrDbContext(optionsBuilder.Options))</span><br></pre></td></tr></table></figure>

<p><code>GetConnectionString</code> 函數實作如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">GetConnectionString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> builder = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">                    .SetBasePath(Directory.GetCurrentDirectory())</span><br><span class="line">                    .AddJsonFile(<span class="string">"appsettings.json"</span>, optional: <span class="literal">false</span>, reloadOnChange: <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">var</span> configuration = builder.Build();</span><br><span class="line">    <span class="keyword">var</span> result = configuration.GetConnectionString(<span class="string">"YourrDbContext"</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="ef-core-沒有-SqlQuery-的解法"><a href="#ef-core-沒有-SqlQuery-的解法" class="headerlink" title="ef core 沒有 SqlQuery 的解法"></a>ef core 沒有 SqlQuery 的解法</h3><p>我升級的版本是用 .net 6 我找到這個<a href="https://github.com/PaulARoy/EntityFrameworkCore.RawSQLExtensions" target="_blank" rel="noopener">套件</a> <code>EntityFrameworkCore.RawSQLExtensions</code><br>有了他以後基本上都無痛解決</p>
<h3 id="ef-core-string-null-噴的錯誤"><a href="#ef-core-string-null-噴的錯誤" class="headerlink" title="ef core string null 噴的錯誤"></a>ef core string null 噴的錯誤</h3><p>在 ef core 裡面預設的 string 會變成 not null 想要沿用以前的行為的話要在 <code>.csproj</code> 把 <code>&lt;Nullable&gt;</code> 註解起來</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--&lt;Nullable&gt;enable&lt;&#x2F;Nullable&gt;--&gt;</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-HasOptional-WithMany"><a href="#ef-core-HasOptional-WithMany" class="headerlink" title="ef core HasOptional WithMany"></a>ef core HasOptional WithMany</h3><p>.net framework</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HasOptional( t =&gt; t.myUser ).WithMany();</span><br></pre></td></tr></table></figure>

<p>.net core</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modelBuilder.Entity&lt;ExtInfo&gt;(entity =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    entity.HasOne(x =&gt; x.myUser).WithMany();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-WillCascadeOnDelete"><a href="#ef-core-WillCascadeOnDelete" class="headerlink" title="ef core WillCascadeOnDelete"></a>ef core WillCascadeOnDelete</h3><p><a href="https://stackoverflow.com/questions/55233677/what-is-the-equivalent-of-willcascadeondeletefalse-in-ef-core" target="_blank" rel="noopener">https://stackoverflow.com/questions/55233677/what-is-the-equivalent-of-willcascadeondeletefalse-in-ef-core</a></p>
<p>在 ef core 沒這個函數了改用 OnDelete(DeleteBehavior.SetNull)</p>
<h3 id="ef-core-HasRequired-WithMany"><a href="#ef-core-HasRequired-WithMany" class="headerlink" title="ef core HasRequired WithMany"></a>ef core HasRequired WithMany</h3><p>.net framework</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HasRequired(t &#x3D;&gt; t.ExtInfo)</span><br><span class="line">.WithMany()</span><br><span class="line">.HasForeignKey(t &#x3D;&gt; t.ExtId);</span><br></pre></td></tr></table></figure>

<p>.net core</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">entity.HasOne(x =&gt; x.ExtInfo)</span><br><span class="line">    .WithMany()</span><br><span class="line">    .HasForeignKey(x =&gt; x.ExtId)</span><br></pre></td></tr></table></figure>



<h3 id="ef-core-多-Key-的問題"><a href="#ef-core-多-Key-的問題" class="headerlink" title="ef core 多 Key 的問題"></a>ef core 多 Key 的問題</h3><p>has multiple properties with the [Key] attribute. Composite primary keys can only be set using ‘HasKey’ in ‘OnModelCreating’</p>
<p><a href="https://stackoverflow.com/questions/74342264/the-entity-type-has-multiple-properties-with-the-key-attribute-composite-prim" target="_blank" rel="noopener">https://stackoverflow.com/questions/74342264/the-entity-type-has-multiple-properties-with-the-key-attribute-composite-prim</a></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    modelBuilder.Entity&lt;MyModel&gt;()</span><br><span class="line">          .HasKey(m =&gt; <span class="keyword">new</span> &#123; m.column1 , m.column2 &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-手殘把關聯鍵設定為物件"><a href="#ef-core-手殘把關聯鍵設定為物件" class="headerlink" title="ef core 手殘把關聯鍵設定為物件"></a>ef core 手殘把關聯鍵設定為物件</h3><p>cannot be used as a property on entity type because it is configured as a navigation</p>
<p>會出現這個應該是手殘打錯</p>
<p><a href="https://stackoverflow.com/questions/58659431/propertyname-cannot-be-used-as-a-property-on-entity-type-typename-because-it" target="_blank" rel="noopener">https://stackoverflow.com/questions/58659431/propertyname-cannot-be-used-as-a-property-on-entity-type-typename-because-it</a></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">ModelBuilder modelBuilder</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    modelBuilder.Entity&lt;User&gt;(user =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        user</span><br><span class="line">        .HasOne(x =&gt; x.Gender)</span><br><span class="line">        .WithMany(x =&gt; x.Users)</span><br><span class="line">        .HasForeignKey(x =&gt; x.GenderId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    user.HasIndex(x =&gt; x.Gender);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這裡這個老外打錯成 <code>user.HasIndex(x =&gt; x.Gender)</code> 正解應該是 <code>user.HasIndex(x =&gt; x.GenderId)</code></p>
<h3 id="ef-core-view-上面-Key-的問題"><a href="#ef-core-view-上面-Key-的問題" class="headerlink" title="ef core view 上面 Key 的問題"></a>ef core view 上面 Key 的問題</h3><p>在舊版會這樣寫</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Table(<span class="meta-string">"YOURVIEW"</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">YOURVIEW</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">Key</span>]</span><br><span class="line">    [<span class="meta">Column( Order = 0 )</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> YOURID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>新版要把 <code>Key</code> 移除然後加上 <code>Keyless</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Table(<span class="meta-string">"YOURVIEW"</span>)</span>]</span><br><span class="line">[<span class="meta">Keyless</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">YOURVIEW</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//todo 他應該是 view 在 ef core 不用寫 Key 也會動</span></span><br><span class="line">    <span class="comment">// [Key]</span></span><br><span class="line">    <span class="comment">// [Column( Order = 0 )]</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> YOURID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-AutoInclude"><a href="#ef-core-AutoInclude" class="headerlink" title="ef core AutoInclude"></a>ef core AutoInclude</h3><p>如果之前的程式查詢下去會出現關聯屬性的話 , 但是你的沒出現則表示沒設定 <code>AutoInclude</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PointLog</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>? Point1Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Point Point1 &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Point</span>&#123;</span><br><span class="line">    [<span class="meta">Key, DatabaseGenerated(DatabaseGeneratedOption.None)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">modelBuilder.Entity&lt;PointLog&gt;().HasOne(x =&gt; x.Point1).WithMany().HasForeignKey(r =&gt; r.Point1Id);</span><br><span class="line">modelBuilder.Entity&lt;PointLog&gt;().Navigation(x =&gt; x.Point1).AutoInclude();</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-HasDatabaseGeneratedOption-DatabaseGeneratedOption-Identity"><a href="#ef-core-HasDatabaseGeneratedOption-DatabaseGeneratedOption-Identity" class="headerlink" title="ef core HasDatabaseGeneratedOption(DatabaseGeneratedOption.Identity)"></a>ef core HasDatabaseGeneratedOption(DatabaseGeneratedOption.Identity)</h3><p>在 .net framework 會寫這樣</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Property( t =&gt; t.Id ).HasDatabaseGeneratedOption( DatabaseGeneratedOption.Identity )</span><br></pre></td></tr></table></figure>

<p>ef core</p>
<p><a href="https://stackoverflow.com/questions/36155429/auto-increment-on-partial-primary-key-with-entity-framework-core" target="_blank" rel="noopener">https://stackoverflow.com/questions/36155429/auto-increment-on-partial-primary-key-with-entity-framework-core</a></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">modelBuilder.Entity&lt;Foo&gt;()</span><br><span class="line">            .Property(f =&gt; f.Id)</span><br><span class="line">            .ValueGeneratedOnAdd();</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-Lazy-loading"><a href="#ef-core-Lazy-loading" class="headerlink" title="ef core Lazy loading"></a>ef core Lazy loading</h3><p>如果想要用 lazy loading 必須要自己手動啟用</p>
<p><a href="https://learn.microsoft.com/en-us/ef/core/querying/related-data/lazy" target="_blank" rel="noopener">https://learn.microsoft.com/en-us/ef/core/querying/related-data/lazy</a></p>
<p>需要先安裝這個套件 <code>Microsoft.EntityFrameworkCore.Proxies</code></p>
<p>另外導覽屬性都要設定 <code>virtual</code> 不然也會噴 error ~</p>
<p>另外要注意如果由 .net framework 升級的會有多處這種地方也要記得跟著修正 <code>var db = new YourDbContext()</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddDbContext&lt;YourDbContext&gt;(options =&gt;</span><br><span class="line">    options.UseLazyLoadingProxies().UseSqlServer(builder.Configuration.GetConnectionString(<span class="string">"YourDbContext"</span>))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>數量太多的話可以在建構子裡面 DbContext 設定 , 參考<a href="https://learn.microsoft.com/zh-tw/ef/core/querying/related-data/lazy" target="_blank" rel="noopener">官網</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)</span><br><span class="line">    &#x3D;&gt; optionsBuilder</span><br><span class="line">        .UseLazyLoadingProxies()</span><br><span class="line">        .UseSqlServer(myConnectionString);</span><br></pre></td></tr></table></figure>


<h3 id="ef-core-Lazy-loading-is-not-supported-for-detached-entities-or-entities-that-are-loaded-with-‘AsNoTracking’"><a href="#ef-core-Lazy-loading-is-not-supported-for-detached-entities-or-entities-that-are-loaded-with-‘AsNoTracking’" class="headerlink" title="ef core Lazy loading is not supported for detached entities or entities that are loaded with ‘AsNoTracking’"></a>ef core Lazy loading is not supported for detached entities or entities that are loaded with ‘AsNoTracking’</h3><p>如果 <code>啟用了 Lazy loading</code> 好像跟 entity framework 寫法略有不同 , 以下這句在 entity framework 是正常的 , 可是 ef core 就需要去掉 <code>AsNoTracking</code></p>
<p>錯誤</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> test = _db.YourTable</span><br><span class="line">    .Where(x =&gt; x.id == id)</span><br><span class="line">    .AsNoTracking()</span><br><span class="line">    .FirstOrDefault();</span><br></pre></td></tr></table></figure>

<p>正常</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> test = _db.YourTable</span><br><span class="line">    .Where(x =&gt; x.id == id)</span><br><span class="line">    .FirstOrDefault();</span><br></pre></td></tr></table></figure>

<p>這裡還有個重點 , 萬一你之前 <code>entity framework 6</code> navigation property 沒有加上 virtual 的話實際上 api 丟出來是取不到東西的像是下面這樣</p>
<p>沒加 <code>virtual</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ForeignKey( <span class="meta-string">"DeptId"</span> )</span>]</span><br><span class="line"><span class="keyword">public</span> DEPT Dept &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>沒加 <code>virtual</code> api 結果</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">"Dept": null,</span><br><span class="line">"Id": "123456",</span><br></pre></td></tr></table></figure>

<p>加了 <code>virtual</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ForeignKey( <span class="meta-string">"DeptId"</span> )</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">virtual</span> DEPT Dept &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>加了 <code>virtual</code> api 結果</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"Dept": &#123;</span><br><span class="line">  "Id": "123456",</span><br><span class="line">  "DeptCode" : "AAA"</span><br><span class="line">&#125;,</span><br><span class="line">"oId": "123456",</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-Precision"><a href="#ef-core-Precision" class="headerlink" title="ef core Precision"></a>ef core Precision</h3><p>No store type was specified for the decimal property ‘YourColumn’ on entity type ‘YourClass’ This will cause values to be silently truncated if they do not fit in the default precision and scale. Explicitly specify the SQL server column type that can accommodate all the values in ‘OnModelCreating’ using ‘HasColumnType’, specify precision and scale using ‘HasPrecision’, or configure a value converter using ‘HasConversion’</p>
<p>這個問題是沒有明確定義資料型別的大小 , 例如 sql server 是 decimal(10,4) 可以用這樣定義</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">YourClass</span>&#123;</span><br><span class="line">    [<span class="meta">Precision(10, 4)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">decimal</span> YourColumn &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或是在 <code>OnModelCreating</code> 這樣定</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">modelBuilder.Entity&lt;YourClass&gt;(entity =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    entity.Property(x =&gt; x.YourColumn).HasPrecision(<span class="number">10</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-Keyless"><a href="#ef-core-Keyless" class="headerlink" title="ef core Keyless"></a>ef core Keyless</h3><p>The entity type ‘YourCol’ has the [Keyless] attribute, but the [Key] attribute was specified on property ‘YourView’; the two are incompatible, consider removing one. Note that the entity will have no key unless you configure one in ‘OnModelCreating’</p>
<p>這個問題應該是你已經在類別設定 <code>Keyless</code> 那個欄位上的 <code>Key</code> 卻忘了移除</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">Keyless</span>]</span><br><span class="line"><span class="keyword">class</span> <span class="title">YourView</span>&#123;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Key</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> YourCol &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-BackingField"><a href="#ef-core-BackingField" class="headerlink" title="ef core BackingField"></a>ef core BackingField</h3><p>Lazy-loaded navigations must have backing fields. Either name the backing field so that it is discovered by convention or configure the backing field to use</p>
<p>這個問題是因為在 .net core 上面要標註 <code>BackingField</code> 不然會噴 error 以前好像沒這東西</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">string</span> name;</span><br><span class="line"></span><br><span class="line">[<span class="meta">BackingField(nameof(name))</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">string</span> Name</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">get</span> &#123; <span class="keyword">return</span> name; &#125;</span><br><span class="line">    <span class="keyword">set</span> &#123; name = <span class="keyword">value</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="ef-core-string-Compare-的坑"><a href="#ef-core-string-Compare-的坑" class="headerlink" title="ef core string.Compare 的坑"></a>ef core string.Compare 的坑</h3><p>本來有有串在 ef 6 這樣寫給過 , 它裡面用了 <code>string.Compare</code> 在 ef core 就炸了</p>
<p>The LINQ expression ‘DbSet<XXX>()<br>.Where(b =&gt;<br>string.Compare(\r\n strA: *<em>code_0, \r\n strB: b.Start, \r\n ignoreCase: True) &gt;= 0 &amp;&amp;<br>string.Compare(\r\n strA: *</em>code_0, \r\n strB: b.End, \r\n ignoreCase: True) &lt;= 0)’<br>could not be translated. </p>
<p>Additional information: Translation of method ‘string.Compare’ failed.<br>If this method can be mapped to your custom function, see <a href="https://go.microsoft.com/fwlink/?linkid=2132413" target="_blank" rel="noopener">https://go.microsoft.com/fwlink/?linkid=2132413</a> for more information.<br>Translation of method ‘string.Compare’ failed.<br>If this method can be mapped to your custom function, see <a href="https://go.microsoft.com/fwlink/?linkid=2132413" target="_blank" rel="noopener">https://go.microsoft.com/fwlink/?linkid=2132413</a> for more information.<br>Either rewrite the query in a form that can be translated, or switch to client evaluation explicitly by inserting a call to ‘AsEnumerable’, ‘AsAsyncEnumerable’, ‘ToList’, or ‘ToListAsync’.<br>See <a href="https://go.microsoft.com/fwlink/?linkid=2101038" target="_blank" rel="noopener">https://go.microsoft.com/fwlink/?linkid=2101038</a> for more information.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> result = db.XXX</span><br><span class="line">.Where( x =&gt; <span class="keyword">string</span>.Compare( code, x.Start, <span class="literal">true</span> ) &gt;= <span class="number">0</span> &amp;&amp; <span class="keyword">string</span>.Compare( code, x.End, <span class="literal">true</span> ) &lt;= <span class="number">0</span> )</span><br><span class="line">.AsNoTracking()</span><br><span class="line">.FirstOrDefault();</span><br></pre></td></tr></table></figure>

<p>舊版打出來的 sql 如下 , 要印出方法可以參考<a href="https://stackoverflow.com/questions/1412863/how-do-i-view-the-sql-generated-by-the-entity-framework" target="_blank" rel="noopener">這裡</a></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sql = ((System.Data.Objects.ObjectQuery)query).ToTraceString();</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">[Extent1].[<span class="keyword">id</span>] <span class="keyword">AS</span> [<span class="keyword">id</span>],</span><br><span class="line">[Extent1].[Code] <span class="keyword">AS</span> [Code],</span><br><span class="line">[Extent1].[<span class="keyword">Start</span>] <span class="keyword">AS</span> [<span class="keyword">Start</span>],</span><br><span class="line">[Extent1].[<span class="keyword">End</span>] <span class="keyword">AS</span> [<span class="keyword">End</span>]</span><br><span class="line"><span class="keyword">FROM</span> [dbo].[XXX] <span class="keyword">AS</span> [Extent1]</span><br><span class="line"><span class="keyword">WHERE</span> (@p__linq__0 &gt;= [Extent1].[<span class="keyword">Start</span>]) <span class="keyword">AND</span> (@p__linq__1 &lt;= [Extent1].[<span class="keyword">End</span>])</span><br></pre></td></tr></table></figure>

<p>後來測半天 , 改用以下查詢</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> result = db.XXX</span><br><span class="line">.Where(x =&gt; code.CompareTo(x.Start) &gt;= <span class="number">0</span>)</span><br><span class="line">.Where(x =&gt; code.CompareTo(x.End) &lt;= <span class="number">0</span>)</span><br><span class="line">.AsNoTracking()</span><br><span class="line">.FirstOrDefault();</span><br></pre></td></tr></table></figure>

<p>打出來的 sql 如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> [b].[<span class="keyword">id</span>], [b].[Code], [b].[<span class="keyword">Start</span>], [b].[<span class="keyword">End</span>]</span><br><span class="line"><span class="keyword">FROM</span> [XXX] <span class="keyword">AS</span> [b]</span><br><span class="line"><span class="keyword">WHERE</span> (@__code_0 &gt;= [b].[StartSeq]) <span class="keyword">AND</span> (@__code_0 &lt;= [b].[EndSeq])</span><br></pre></td></tr></table></figure>


<h3 id="ef-core-‘System-Single’-to-type-‘System-Double’-’"><a href="#ef-core-‘System-Single’-to-type-‘System-Double’-’" class="headerlink" title="ef core ‘System.Single’ to type ‘System.Double’.’"></a>ef core ‘System.Single’ to type ‘System.Double’.’</h3><p>這個問題是你設定的 entity 資料型別與 db 的不相符合</p>
<p>例如測試機寫成 real , 正式機用 decimal 然後你的 entity 設定資料型別用 decimal</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">entity.Property(x =&gt; x.Power).HasPrecision(<span class="number">14</span>, <span class="number">5</span>);</span><br></pre></td></tr></table></figure>

<p>要比對正式與測試的 table 可以先 create as script</p>
<p>然後用這個<a href="https://www.diffchecker.com/text-compare/" target="_blank" rel="noopener">線上工具</a> 看看印出來的相異之處</p>
<h3 id="ef-core-CTE"><a href="#ef-core-CTE" class="headerlink" title="ef core CTE"></a>ef core CTE</h3><p>這個還滿雷的跟以前寫發差異有點多 , 要先定義 CTE 的類別在 DbContext , 並且類別的欄位一定要用到 , 不然也會噴錯<br>還有如果偷懶有兩個 column 名稱一樣的話 , 也是會炸 , 要特別注意</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public virtual DbSet&lt;YOURCTEVIEW&gt; YOURCTEVIEW &#123; get; set; &#125;</span><br></pre></td></tr></table></figure>

<p>接著在 <code>OnModelCreating</code> 定義這個設定</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">modelBuilder.Entity&lt;YOURCTEVIEW&gt;().HasNoKey().ToView(null);</span><br></pre></td></tr></table></figure>

<p>最後使用的時候要這樣寫</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.Set&lt;YOURCTEVIEW&gt;().FromSqlRaw(sql).ToList();</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-HasPrecision-快速修正"><a href="#ef-core-HasPrecision-快速修正" class="headerlink" title="ef core HasPrecision 快速修正"></a>ef core HasPrecision 快速修正</h3><p>warn: Microsoft.EntityFrameworkCore.Model.Validation[30000]<br>      No store type was specified for the decimal property ‘COLUMNNAME’ on entity type ‘TABLENAME’.<br>      This will cause values to be silently truncated if they do not fit in the default precision and scale.<br>      Explicitly specify the SQL server column type that can accommodate all the values in ‘OnModelCreating’ using ‘HasColumnType’,<br>      specify precision and scale using ‘HasPrecision’,<br>      or configure a value converter using ‘HasConversion’.</p>
<p>如果噴一堆這種類似的錯誤他會跳警告 , 可以在 sql server 上面下這串 , 自己產 code 然後加在 DbContext 裡面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select COLUMN_NAME , NUMERIC_PRECISION , NUMERIC_SCALE , </span><br><span class="line">&#39;entity.Property(e&#x3D;&gt;e.&#39; + COLUMN_NAME + &#39;).HasPrecision(&#39;+ convert(varchar, NUMERIC_PRECISION) + &#39;, &#39;+ convert(varchar,NUMERIC_SCALE) + &#39;);&#39;</span><br><span class="line">from INFORMATION_SCHEMA.COLUMNS</span><br><span class="line">where TABLE_NAME&#x3D;&#39;TABLENAME&#39;</span><br><span class="line">and DATA_TYPE &#x3D; &#39;decimal&#39;</span><br></pre></td></tr></table></figure>

<p>最後在 OnModelCreating 加上去</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modelBuilder.Entity&lt;TABLENAME&gt;(entity &#x3D;&gt;</span><br><span class="line">&#123;</span><br><span class="line">	entity.Property(e &#x3D;&gt; e.COLUMNNAME).HasPrecision(8, 1);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="ef-core-CommandTimeout"><a href="#ef-core-CommandTimeout" class="headerlink" title="ef core CommandTimeout"></a>ef core CommandTimeout</h3><p><a href="https://stackoverflow.com/questions/39058422/how-to-set-command-timeout-in-asp-net-core-entity-framework-core" target="_blank" rel="noopener">https://stackoverflow.com/questions/39058422/how-to-set-command-timeout-in-asp-net-core-entity-framework-core</a></p>
<p>舊版</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.Database.CommandTimeout &#x3D; 300;</span><br></pre></td></tr></table></figure>

<p>.net core</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var optionsBuilder &#x3D; new DbContextOptionsBuilder&lt;YourDbContext&gt;();</span><br><span class="line">optionsBuilder.UseOracle(GetDbConnectionString() , opt &#x3D;&gt; opt.CommandTimeout(60));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">services.AddDbContext&lt;YourDbContext&gt;(options &#x3D;&gt; options.UseOracle(</span><br><span class="line">    this.Configuration.GetConnectionString(&quot;YourConnectionString&quot;),</span><br><span class="line">    sqlServerOptions &#x3D;&gt; sqlServerOptions.CommandTimeout(60))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>


<h3 id="ef-core-Connection-State"><a href="#ef-core-Connection-State" class="headerlink" title="ef core Connection.State"></a>ef core Connection.State</h3><p>舊版</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if (db.Database.Connection.State !&#x3D; ConnectionState.Open)</span><br><span class="line">	db.Database.Connection.Open();</span><br></pre></td></tr></table></figure>

<p>.net core</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if (db.Database.GetDbConnection().State !&#x3D; ConnectionState.Open)</span><br><span class="line">	db.Database.GetDbConnection().Open();</span><br></pre></td></tr></table></figure>


<h3 id="ef-core-Cannot-convert-implicitly-a-type-‘System-Linq-IQueryable’-into-‘Microsoft-EntityFrameworkCore-Query-IIncludableQueryable’"><a href="#ef-core-Cannot-convert-implicitly-a-type-‘System-Linq-IQueryable’-into-‘Microsoft-EntityFrameworkCore-Query-IIncludableQueryable’" class="headerlink" title="ef core Cannot convert implicitly a type ‘System.Linq.IQueryable’ into ‘Microsoft.EntityFrameworkCore.Query.IIncludableQueryable’"></a>ef core Cannot convert implicitly a type ‘System.Linq.IQueryable’ into ‘Microsoft.EntityFrameworkCore.Query.IIncludableQueryable’</h3><p>參考這篇<br><a href="https://iditect.com/faq/csharp/cannot-convert-implicitly-a-type-39systemlinqiqueryable39-into-39microsoftentityframeworkcorequeryiincludablequeryable39.html" target="_blank" rel="noopener">https://iditect.com/faq/csharp/cannot-convert-implicitly-a-type-39systemlinqiqueryable39-into-39microsoftentityframeworkcorequeryiincludablequeryable39.html</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; This will throw a compile-time error</span><br><span class="line">var query &#x3D; context.MyEntity.Include(e &#x3D;&gt; e.RelatedEntity);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; This will work correctly</span><br><span class="line">var query &#x3D; context.MyEntity.Include(e &#x3D;&gt; e.RelatedEntity).AsQueryable();</span><br></pre></td></tr></table></figure>


<h2 id="Autofac"><a href="#Autofac" class="headerlink" title="Autofac"></a>Autofac</h2><h3 id="Autofac-注入-DbContext"><a href="#Autofac-注入-DbContext" class="headerlink" title="Autofac 注入 DbContext"></a>Autofac 注入 DbContext</h3><p>基本上最好是用注入的</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">builder.Register(x =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> optionsBuilder = <span class="keyword">new</span> DbContextOptionsBuilder&lt;YourDbContext&gt;();</span><br><span class="line">    optionsBuilder.UseSqlServer(configuration.GetConnectionString(<span class="string">"YourDbContext"</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> YourDbContext(optionsBuilder.Options);</span><br><span class="line">&#125;)</span><br><span class="line">.InstancePerLifetimeScope()</span><br><span class="line">.Named(<span class="string">"db"</span>, <span class="keyword">typeof</span>(YourDbContext));</span><br></pre></td></tr></table></figure>

<h3 id="Autofac-注入多參數建構子"><a href="#Autofac-注入多參數建構子" class="headerlink" title="Autofac 注入多參數建構子"></a>Autofac 注入多參數建構子</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">builder.RegisterType&lt;OOService&gt;()</span><br><span class="line">    .As&lt;IOOService&gt;()</span><br><span class="line">    .UsingConstructor(</span><br><span class="line">        <span class="keyword">typeof</span>(YourDbContext),</span><br><span class="line">        <span class="keyword">typeof</span>(GGDbContext)</span><br><span class="line">    )</span><br><span class="line">    .WithParameters(<span class="keyword">new</span> List&lt;ResolvedParameter&gt;() &#123;</span><br><span class="line">        <span class="keyword">new</span> ResolvedParameter(</span><br><span class="line">            (pi, ctx) =&gt; pi.ParameterType == <span class="keyword">typeof</span>(YourDbContext),</span><br><span class="line">            (pi, ctx) =&gt; ctx.ResolveNamed&lt;YourDbContext&gt;(<span class="string">"db"</span>)),</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> ResolvedParameter(</span><br><span class="line">            (pi, ctx) =&gt; pi.ParameterType == <span class="keyword">typeof</span>(GGDbContext),</span><br><span class="line">            (pi, ctx) =&gt; ctx.ResolveNamed&lt;GGDbContext&gt;(<span class="string">"gg"</span>))</span><br><span class="line">    &#125;)</span><br><span class="line">    .Named(<span class="string">"ooService"</span>, <span class="keyword">typeof</span>(IOOService));</span><br></pre></td></tr></table></figure>

<h3 id="Autofac-注入物件"><a href="#Autofac-注入物件" class="headerlink" title="Autofac 注入物件"></a>Autofac 注入物件</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//這裡好像不加 As 使用具名會壞掉</span></span><br><span class="line">builder.RegisterType&lt;OOService&gt;()</span><br><span class="line">.As&lt;OOService&gt;()</span><br><span class="line">.Named(<span class="string">"ooService"</span>,<span class="keyword">typeof</span>(OOService));</span><br></pre></td></tr></table></figure>

<h2 id="其他類"><a href="#其他類" class="headerlink" title="其他類"></a>其他類</h2><h3 id="ApiController-修正"><a href="#ApiController-修正" class="headerlink" title="ApiController 修正"></a>ApiController 修正</h3><p>.net core 改用 <code>IActionResult</code> 取代 <code>IHttpActionResult</code></p>
<h3 id="Newtonsoft"><a href="#Newtonsoft" class="headerlink" title="Newtonsoft"></a>Newtonsoft</h3><p>舊版 <code>.net framework</code> 應該都用 <code>Newtonsoft</code><br><code>.net core</code> 預設會用 <code>System.Text.Json</code> 來處理 json<br>所以最好安裝以下這兩個套件<br><code>Microsoft.AspNetCore.Mvc.NewtonsoftJson</code><br><code>Swashbuckle.AspNetCore.Newtonsoft</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddControllers().AddNewtonsoftJson(opt =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    opt.SerializerSettings.ReferenceLoopHandling = Newtonsoft.Json.ReferenceLoopHandling.Ignore;</span><br><span class="line">    opt.SerializerSettings.ContractResolver = <span class="keyword">new</span> CamelCasePropertyNamesContractResolver();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">builder.Services.AddEndpointsApiExplorer();</span><br><span class="line">builder.Services.AddSwaggerGen(options =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    options.SwaggerDoc(<span class="string">"v1"</span>, <span class="keyword">new</span> OpenApiInfo</span><br><span class="line">    &#123;</span><br><span class="line">        Version = <span class="string">"v1"</span>,</span><br><span class="line">        Title = <span class="string">"ToDo API"</span>,</span><br><span class="line">        Description = <span class="string">"An ASP.NET Core Web API for managing ToDo items"</span>,</span><br><span class="line">        TermsOfService = <span class="keyword">new</span> Uri(<span class="string">"https://example.com/terms"</span>),</span><br><span class="line">        Contact = <span class="keyword">new</span> OpenApiContact</span><br><span class="line">        &#123;</span><br><span class="line">            Name = <span class="string">"Example Contact"</span>,</span><br><span class="line">            Url = <span class="keyword">new</span> Uri(<span class="string">"https://example.com/contact"</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        License = <span class="keyword">new</span> OpenApiLicense</span><br><span class="line">        &#123;</span><br><span class="line">            Name = <span class="string">"Example License"</span>,</span><br><span class="line">            Url = <span class="keyword">new</span> Uri(<span class="string">"https://example.com/license"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// using System.Reflection;</span></span><br><span class="line">    <span class="keyword">var</span> xmlFilename = <span class="string">$"<span class="subst">&#123;Assembly.GetExecutingAssembly().GetName().Name&#125;</span>.xml"</span>;</span><br><span class="line">    options.IncludeXmlComments(Path.Combine(AppContext.BaseDirectory, xmlFilename));</span><br><span class="line">&#125;);</span><br><span class="line">builder.Services.AddSwaggerGenNewtonsoftSupport();</span><br></pre></td></tr></table></figure>

<p>此外好像 <code>.csproj</code> 還要加上這個設定才會正常產文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">GenerateDocumentationFile</span>&gt;</span>true<span class="tag">&lt;/<span class="name">GenerateDocumentationFile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">NoWarn</span>&gt;</span>$(NoWarn);1591<span class="tag">&lt;/<span class="name">NoWarn</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="UserManager-CreateIdentityAsync-移除的解法"><a href="#UserManager-CreateIdentityAsync-移除的解法" class="headerlink" title="UserManager CreateIdentityAsync 移除的解法"></a>UserManager CreateIdentityAsync 移除的解法</h3><p>在 .net framework 使用到了 <code>CreateIdentityAsync</code> 這個函數但是 .net core 已經移除了</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//他這裡 return ClaimsIdentity</span></span><br><span class="line"><span class="keyword">var</span> claimsIdentity = <span class="keyword">await</span> mgr.CreateIdentityAsync(<span class="keyword">this</span>, DefaultAuthenticationTypes.ApplicationCookie);</span><br></pre></td></tr></table></figure>

<p>我目前的解法是改用如下方式 , 不過尚未驗證<br>可參考<br><a href="https://stackoverflow.com/questions/40304516/the-name-defaultauthenticationtypes-does-not-exist-in-the-current-context" target="_blank" rel="noopener">https://stackoverflow.com/questions/40304516/the-name-defaultauthenticationtypes-does-not-exist-in-the-current-context</a><br><a href="https://github.com/aspnet/AspNetIdentity/blob/main/src/Microsoft.AspNet.Identity.Core/DefaultAuthenticationTypes.cs" target="_blank" rel="noopener">https://github.com/aspnet/AspNetIdentity/blob/main/src/Microsoft.AspNet.Identity.Core/DefaultAuthenticationTypes.cs</a></p>
<p>這句 <code>DefaultAuthenticationTypes.ApplicationCookie</code> 就是個常數 <code>ApplicationCookie</code></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> claimsIdentity = <span class="keyword">new</span> ClaimsIdentity(<span class="keyword">await</span> mgr.GetClaimsAsync(<span class="keyword">this</span>), <span class="string">"ApplicationCookie"</span>);</span><br></pre></td></tr></table></figure>

<h3 id="AspNetUser-資料表的問題"><a href="#AspNetUser-資料表的問題" class="headerlink" title="AspNetUser 資料表的問題"></a>AspNetUser 資料表的問題</h3><p>如果要在 .net core 使用 <code>IdentityUser</code> 的話會噴以下錯誤 , 這是因為新的資料表有這些欄位 , 升級時應該要注意下這個部分</p>
<p><a href="https://stackoverflow.com/questions/50343512/migrate-existing-microsoft-aspnet-identity-db-ef-6-to-microsoft-aspnetcore-ide" target="_blank" rel="noopener">https://stackoverflow.com/questions/50343512/migrate-existing-microsoft-aspnet-identity-db-ef-6-to-microsoft-aspnetcore-ide</a></p>
<p><a href="https://www.youtube.com/watch?v=CByZc2CDDqE" target="_blank" rel="noopener">https://www.youtube.com/watch?v=CByZc2CDDqE</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Microsoft.Data.SqlClient.SqlException (0x80131904): 無效的資料行名稱 &#39;ConcurrencyStamp&#39;。</span><br><span class="line">無效的資料行名稱 &#39;LockoutEnd&#39;。</span><br><span class="line">無效的資料行名稱 &#39;NormalizedEmail&#39;。</span><br><span class="line">無效的資料行名稱 &#39;NormalizedUserName</span><br></pre></td></tr></table></figure>

<h3 id="Application-Start-的解法"><a href="#Application-Start-的解法" class="headerlink" title="Application_Start 的解法"></a>Application_Start 的解法</h3><p>var app = builder.Build();</p>
<p>//<a href="https://learn.microsoft.com/zh-tw/aspnet/core/migration/50-to-60-samples?view=aspnetcore-8.0" target="_blank" rel="noopener">https://learn.microsoft.com/zh-tw/aspnet/core/migration/50-to-60-samples?view=aspnetcore-8.0</a><br>IHostApplicationLifetime lifetime = app.Lifetime;</p>
<p>//Application_Start<br>lifetime.ApplicationStarted.Register(() =&gt;<br>{<br>    //你需要執行的內容<br>});</p>
<h3 id="MapPath-的解法"><a href="#MapPath-的解法" class="headerlink" title="MapPath 的解法"></a>MapPath 的解法</h3><p>假設有用到 <code>MapPath</code> 取得 <code>App_Data</code> 資料夾的話 , 可以用以下方法解決</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;var targetPath &#x3D; $&quot;&#123;HostingEnvironment.MapPath(&quot;~&#x2F;App_Data&quot;)&#125;&#x2F;photos&quot;;</span><br><span class="line">var targetPath &#x3D; Path.Combine(Directory.GetCurrentDirectory(), &quot;App_Data&#x2F;photos&quot;);</span><br></pre></td></tr></table></figure>

<h3 id="ActionFilter-OnActionExecuted-的坑"><a href="#ActionFilter-OnActionExecuted-的坑" class="headerlink" title="ActionFilter OnActionExecuted 的坑"></a>ActionFilter OnActionExecuted 的坑</h3><p>在舊版的 mvc 裡面自訂 ActionFilter 通常會複寫 <code>OnActionExecuting</code> 及 <code>OnActionExecuted</code><br>可以用 <code>HttpActionContext</code> 的 <code>ActionArguments</code> 去塞一些狀態 , 如執行時間 , 拿 client ip 作比對等等 , 大概長以下這樣</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public override void OnActionExecuting( HttpActionContext actionContext )&#123;</span><br><span class="line">	actionContext.ActionArguments[&quot;ip&quot;] &#x3D; ip;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public override void OnActionExecuted( HttpActionExecutedContext filterContext )&#123;</span><br><span class="line">	var ip &#x3D; filterContext.ActionContext.ActionArguments[&quot;ip&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可是在 . net core 裡面是拿不到 OnActionExecuted 裡面的東東 , 所以要改寫這樣</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public override void OnActionExecuting(ActionExecutingContext context)&#123;</span><br><span class="line"></span><br><span class="line">	var ip &#x3D; context.HttpContext.Features.Get&lt;IHttpConnectionFeature&gt;()?.RemoteIpAddress.ToString();</span><br><span class="line">	context.HttpContext.Items[&quot;ip&quot;] &#x3D; ip;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public override void OnActionExecuted(ActionExecutedContext context)&#123;</span><br><span class="line">	var ip &#x3D; (T)context.HttpContext.Items[&quot;ip&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="多語系"><a href="#多語系" class="headerlink" title="多語系"></a>多語系</h3><p>多語系如果沿用舊版的 Resource 可以這樣寫 , 他會在你 Request 裡面去用對應的語系處理 , 幾乎無痛升級<br>一開始看到要在 controller 加上一堆 <code>IStringLocalizer</code> 差點嚇死 , 好險後來找到這個方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">builder.Services.AddLocalization();</span><br><span class="line">   builder.Services.Configure&lt;RequestLocalizationOptions&gt;(</span><br><span class="line">       options &#x3D;&gt;</span><br><span class="line">       &#123;</span><br><span class="line">           &#x2F;&#x2F;取得目前語系</span><br><span class="line">           var currentCulture &#x3D; CultureInfo.CurrentCulture;</span><br><span class="line">           Console.WriteLine(currentCulture);</span><br><span class="line">           var supportedCultures &#x3D; new List&lt;CultureInfo&gt;</span><br><span class="line">           &#123;</span><br><span class="line">               new CultureInfo(&quot;zh-TW&quot;),</span><br><span class="line">               new CultureInfo(&quot;en&quot;),</span><br><span class="line">               new CultureInfo(&quot;zh-CN&quot;),</span><br><span class="line">           &#125;;</span><br><span class="line"></span><br><span class="line">           &#x2F;&#x2F;設定目前語系</span><br><span class="line">           options.DefaultRequestCulture &#x3D; new RequestCulture(currentCulture);</span><br><span class="line">           &#x2F;&#x2F;options.DefaultRequestCulture &#x3D; new RequestCulture(culture: &quot;en-US&quot;, uiCulture: &quot;en-US&quot;);</span><br><span class="line"></span><br><span class="line">           options.SupportedCultures &#x3D; supportedCultures;</span><br><span class="line">           options.SupportedUICultures &#x3D; supportedCultures;</span><br><span class="line">       &#125;);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">   &#x2F;&#x2F;多語系</span><br><span class="line">   app.UseRequestLocalization();</span><br></pre></td></tr></table></figure>

<h3 id="IHttpActionResult"><a href="#IHttpActionResult" class="headerlink" title="IHttpActionResult"></a>IHttpActionResult</h3><p>基本上看到 IHttpActionResult 只要改成 IActionResult 即可</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/c/" rel="tag"># c#</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/12/18/python-%E6%AD%A3%E5%A6%B9%E5%88%86%E6%9E%90/" rel="prev" title="python 正妹分析">
      <i class="fa fa-chevron-left"></i> python 正妹分析
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/01/19/c-%E6%B3%9B%E5%9E%8B%E6%96%B9%E6%B3%95%E5%AF%A6%E5%8B%99/" rel="next" title="c# 泛型方法實務">
      c# 泛型方法實務 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ef-core"><span class="nav-number">1.</span> <span class="nav-text">ef core</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-The-entity-type-‘IdentityUserLogin‘-requires-a-primary-key-to-be-defined"><span class="nav-number">1.1.</span> <span class="nav-text">ef core The entity type ‘IdentityUserLogin‘ requires a primary key to be defined</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-DbContext-Include-Roles"><span class="nav-number">1.2.</span> <span class="nav-text">ef core DbContext Include Roles</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-new-DbContext"><span class="nav-number">1.3.</span> <span class="nav-text">ef core new DbContext</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-沒有-SqlQuery-的解法"><span class="nav-number">1.4.</span> <span class="nav-text">ef core 沒有 SqlQuery 的解法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-string-null-噴的錯誤"><span class="nav-number">1.5.</span> <span class="nav-text">ef core string null 噴的錯誤</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-HasOptional-WithMany"><span class="nav-number">1.6.</span> <span class="nav-text">ef core HasOptional WithMany</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-WillCascadeOnDelete"><span class="nav-number">1.7.</span> <span class="nav-text">ef core WillCascadeOnDelete</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-HasRequired-WithMany"><span class="nav-number">1.8.</span> <span class="nav-text">ef core HasRequired WithMany</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-多-Key-的問題"><span class="nav-number">1.9.</span> <span class="nav-text">ef core 多 Key 的問題</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-手殘把關聯鍵設定為物件"><span class="nav-number">1.10.</span> <span class="nav-text">ef core 手殘把關聯鍵設定為物件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-view-上面-Key-的問題"><span class="nav-number">1.11.</span> <span class="nav-text">ef core view 上面 Key 的問題</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-AutoInclude"><span class="nav-number">1.12.</span> <span class="nav-text">ef core AutoInclude</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-HasDatabaseGeneratedOption-DatabaseGeneratedOption-Identity"><span class="nav-number">1.13.</span> <span class="nav-text">ef core HasDatabaseGeneratedOption(DatabaseGeneratedOption.Identity)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-Lazy-loading"><span class="nav-number">1.14.</span> <span class="nav-text">ef core Lazy loading</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-Lazy-loading-is-not-supported-for-detached-entities-or-entities-that-are-loaded-with-‘AsNoTracking’"><span class="nav-number">1.15.</span> <span class="nav-text">ef core Lazy loading is not supported for detached entities or entities that are loaded with ‘AsNoTracking’</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-Precision"><span class="nav-number">1.16.</span> <span class="nav-text">ef core Precision</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-Keyless"><span class="nav-number">1.17.</span> <span class="nav-text">ef core Keyless</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-BackingField"><span class="nav-number">1.18.</span> <span class="nav-text">ef core BackingField</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-string-Compare-的坑"><span class="nav-number">1.19.</span> <span class="nav-text">ef core string.Compare 的坑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-‘System-Single’-to-type-‘System-Double’-’"><span class="nav-number">1.20.</span> <span class="nav-text">ef core ‘System.Single’ to type ‘System.Double’.’</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-CTE"><span class="nav-number">1.21.</span> <span class="nav-text">ef core CTE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-HasPrecision-快速修正"><span class="nav-number">1.22.</span> <span class="nav-text">ef core HasPrecision 快速修正</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-CommandTimeout"><span class="nav-number">1.23.</span> <span class="nav-text">ef core CommandTimeout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-Connection-State"><span class="nav-number">1.24.</span> <span class="nav-text">ef core Connection.State</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ef-core-Cannot-convert-implicitly-a-type-‘System-Linq-IQueryable’-into-‘Microsoft-EntityFrameworkCore-Query-IIncludableQueryable’"><span class="nav-number">1.25.</span> <span class="nav-text">ef core Cannot convert implicitly a type ‘System.Linq.IQueryable’ into ‘Microsoft.EntityFrameworkCore.Query.IIncludableQueryable’</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Autofac"><span class="nav-number">2.</span> <span class="nav-text">Autofac</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Autofac-注入-DbContext"><span class="nav-number">2.1.</span> <span class="nav-text">Autofac 注入 DbContext</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Autofac-注入多參數建構子"><span class="nav-number">2.2.</span> <span class="nav-text">Autofac 注入多參數建構子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Autofac-注入物件"><span class="nav-number">2.3.</span> <span class="nav-text">Autofac 注入物件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#其他類"><span class="nav-number">3.</span> <span class="nav-text">其他類</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ApiController-修正"><span class="nav-number">3.1.</span> <span class="nav-text">ApiController 修正</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Newtonsoft"><span class="nav-number">3.2.</span> <span class="nav-text">Newtonsoft</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UserManager-CreateIdentityAsync-移除的解法"><span class="nav-number">3.3.</span> <span class="nav-text">UserManager CreateIdentityAsync 移除的解法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AspNetUser-資料表的問題"><span class="nav-number">3.4.</span> <span class="nav-text">AspNetUser 資料表的問題</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Application-Start-的解法"><span class="nav-number">3.5.</span> <span class="nav-text">Application_Start 的解法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MapPath-的解法"><span class="nav-number">3.6.</span> <span class="nav-text">MapPath 的解法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ActionFilter-OnActionExecuted-的坑"><span class="nav-number">3.7.</span> <span class="nav-text">ActionFilter OnActionExecuted 的坑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多語系"><span class="nav-number">3.8.</span> <span class="nav-text">多語系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IHttpActionResult"><span class="nav-number">3.9.</span> <span class="nav-text">IHttpActionResult</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="🌹 喇賽人 🌹"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">🌹 喇賽人 🌹</p>
  <div class="site-description" itemprop="description">🌹 喇賽人的 Blog 🌹</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">310</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">119</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/weber87na" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;weber87na" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

	  <!-- skilltree 廣告 -->
	  <div id="myadblock" style="margin-top:25px;position:relative">
	  <div id="myadblock-title" style="position:absolute;left:-10px;top:-10px;width:100px;background-color:rgba(0,0,0,.75);color:white;">偷放工商</div>
	  <script src="https://skilltree.my/promotion/cec9b4b0-be5e-4727-85c6-f7af5445124a?w=350"></script>
	  </div>

	  <!-- google 廣告 -->
	  <!--
	  <ins class="adsbygoogle"
		  style="display:inline-block;width:220px;height:120px;margin-top:50px;position:relative;border-bottom-left-radius: 15px 255px;border-bottom-right-radius: 225px 15px;border-top-left-radius: 255px 15px;border-top-right-radius: 15px 225px;border: 2px solid #41403e;"
		  data-ad-client="ca-pub-1069539516107706"
		  data-ad-slot="6588270137">
	  <div id="myadblock-title2" style="z-index:999999;position:absolute;left:-10px;top:-10px;width:100px;background-color:rgba(0,0,0,.75);color:white;">偷放工商</div>
	  </ins>
	  <script>
		  (adsbygoogle = window.adsbygoogle || []).push({});
	  </script>
	  -->

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">喇賽的人! G__G+</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">總廢話字數：</span>
    <span title="總廢話字數">1.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">所需總浪費時間 &asymp;</span>
    <span title="所需總浪費時間">24:39</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://la-sai-de-ren.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://www.blog.lasai.com.tw/2023/12/28/net-framework-4-8-to-net-core-%E7%AD%86%E8%A8%98/";
    this.page.identifier = "2023/12/28/net-framework-4-8-to-net-core-筆記/";
    this.page.title = ".net framework 4.8 to .net core 筆記";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://la-sai-de-ren.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>


  <!-- <div class="snow1" style="position:fixed !important"></div> -->
  <div class="cobweb" style="position:fixed !important"></div>
  <div class="spider" style="position:fixed !important"></div>
<div class="fswitch">關閉</div>
<div class="snowflakes" aria-hidden="true">
  <div class="snowflake">
 🌹
  </div>
  <div class="snowflake">
 💩
  </div>
  <div class="snowflake">
 🌹
  </div>
  <div class="snowflake">
 💩
  </div>
    <div class="snowflake">
 🌹
  </div>
  <div class="snowflake">
 💩
  </div>
    <div class="snowflake">
 🌹
  </div>
  <div class="snowflake">
 💩
  </div>
</div>

<!--
<script>
	function toggleSpell() {
		let spell = document.getElementsByClassName('spell')[0];
		let ghost = document.getElementsByClassName('ghost')[0];
		let noise = document.getElementsByClassName('noise')[0];
		let noise2 = document.getElementsByClassName('noise2')[0];
		if (spell.style.display === 'none') {
			spell.style.display = 'block';
			noise.style.display = '';
			noise2.style.display = '';
			ghost.style.display = 'none';
		} else {
			spell.style.display = 'none';
			noise.style.display = 'none';
			noise2.style.display = 'none';
			ghost.style.display = 'block';
		}
	}

	//訂閱內容
	let spell = document.getElementsByClassName('spell')[0];
	let ghost = document.getElementsByClassName('ghost')[0];
	spell.addEventListener('click',toggleSpell);
	ghost.addEventListener('click',toggleSpell);
</script>
-->

<script>

let cobweb = document.querySelector('.cobweb');
let spider = document.querySelector('.spider');
let back = document.querySelector('.back-to-top');
let fswitch = document.querySelector('.fswitch');

document.addEventListener('keydown', function(event) {
	if (event.key === 'f') {
		console.log('press f key');
		ftoggle();
	}
});

fswitch.addEventListener('click' , function(){ 
	ftoggle();
});

function ftoggle(){
	if(cobweb.style.display === ''){
		cobweb.style.display = 'none';
	}else{
		cobweb.style.display = '';
	}
	if(spider.style.display === ''){
		spider.style.display = 'none';
	}else{
		spider.style.display = '';
	}
	if(back.style.display === ''){
		back.style.display = 'none';
	}else{
		back.style.display = '';
	}

	if(fswitch.innerText === '關閉') fswitch.innerText = '乖乖'
	else fswitch.innerText = '關閉'
}



</script>

<script>
class ViNavigation {
  constructor() {
    this.Mode = {
      Normal: "normal",
      Motion: "motion",
    };

    this.lastKeyPressTime = 0;
    this.lastKeyPressed = "";
    this.currentMode = this.Mode.Normal;

    //可使用移動的字碼
    //共 18 個字 排除 vi 會用到的字
    this.tagChars = "ABCEILNOPQRSTVWXYZ";

    //目前的 vim 標示字標籤 array
    this.holdTags = new Array();

    //預先建立兩字組合的字典
    this.dict = new Array();
    //雙層迴圈灌入所有兩字組合
    for (var i = 0; i < this.tagChars.length; i++) {
      for (var j = 0; j < this.tagChars.length; j++) {
        this.dict.push(this.tagChars[i] + this.tagChars[j]);
      }
    }
  }

  viGoTop(keyPressed) {
    if (keyPressed === "g") {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  }

  viGoBottom(keyPressed) {
    if (keyPressed === "G") {
      console.log("document.body.scrollHeight", document.body.scrollHeight);
      let h = Math.max(
        Math.max(
          document.body.scrollHeight,
          document.documentElement.scrollHeight
        ),
        Math.max(
          document.body.offsetHeight,
          document.documentElement.offsetHeight
        ),
        Math.max(
          document.body.clientHeight,
          document.documentElement.clientHeight
        )
      );
      window.scrollTo({ top: h, behavior: "smooth" });
    }
  }

  viFastDown(keyPressed) {
    if (keyPressed === "d") {
      this.move(350);
    }
  }

  viDown(keyPressed) {
    if (keyPressed === "j") {
      this.move(100);
    }
  }

  viFastUp(keyPressed) {
    if (keyPressed === "u") {
      this.move(-350);
    }
  }

  viUp(keyPressed) {
    if (keyPressed === "k") {
      this.move(-100);
    }
  }

  move(val) {
    var currentPosition =
      window.pageYOffset || document.documentElement.scrollTop;
    window.scrollTo({
      top: currentPosition + val,
      behavior: "smooth",
    });
  }

  removeViTags() {
    let allTags = document.querySelectorAll(".vim-tag");
    allTags.forEach(function (tag) {
      tag.parentNode.removeChild(tag);
    });
  }

  createViTag(text, href, top, left) {
    let newDiv = document.createElement("div");
    newDiv.classList.add("vim-tag");
    newDiv.style.fontFamily = "Arial, sans-serif";
    newDiv.style.fontSize = "12px";
    newDiv.style.position = "absolute";
    newDiv.style.backgroundColor = "#89CF07";
    newDiv.style.color = "black";
    newDiv.style.padding = "2px";
    newDiv.style.borderRadius = "2px";
    newDiv.style.zIndex = "999999";

    newDiv.textContent = text;
    newDiv.dataset.href = href;
    newDiv.style.top = top;
    newDiv.style.left = left;
    return newDiv;
  }

  createViTags() {
    let allTags = document.querySelectorAll("a");
    let counter = 0;
    for (let tag of allTags) {
      let rect = tag.getBoundingClientRect();
      let href = tag.href;
      //這個距離需要加入卷軸距離才會正確
      let top = window.scrollY + rect.top + "px";
      let left = window.scrollX + rect.left + "px";
      let text = "";
      if (allTags.length <= this.tagChars.length) {
        text = this.tagChars[counter];
        this.holdTags.push(text);
      } else {
        text = this.dict[counter];
        this.holdTags.push(text);
      }
      let newDiv = this.createViTag(text, href, top, left);
      document.body.appendChild(newDiv);
      counter++;
    }
  }

  //找出目前的首字 array
  firstCharArray() {
    let result = [];
    for (let i = 0; i < this.holdTags.length; i++) {
      let text = this.holdTags[i];
      if (text) {
        let theChar = text[0].toLowerCase();
        if (result.includes(theChar) === false) {
          result.push(theChar);
        }
      }
    }

    return result;
  }

  toggleMotion() {
    this.currentMode = this.Mode.Motion;
    this.lastKeyPressed = "";
    console.log("mode", this.currentMode);
    this.createViTags();
  }

  toggleNormal() {
    this.currentMode = this.Mode.Normal;
    console.log("mode", this.currentMode);
    this.removeViTags();
    this.holdTags = [];
    this.lastKeyPressed = "";
  }

  handleKeyDown(event) {
    let currentTime = new Date().getTime();
    let keyPressed = event.key;

    //按下 F 時進入 motion 模式
    if (this.currentMode === this.Mode.Normal && keyPressed === "F") {
      this.toggleMotion();
      return;
    }

    //按下 esc 跳離 motion 模式回到 normal 模式
    if (this.currentMode === this.Mode.Motion && keyPressed === "Escape") {
      this.toggleNormal();
      return;
    }

    //當 motion 一個字時才走這模式
    if (
      this.currentMode === this.Mode.Motion &&
      document.querySelectorAll("a").length <= this.tagChars.length &&
      this.tagChars.toLowerCase().includes(keyPressed)
    ) {
      console.log("one char mode");
      let allTags = document.querySelectorAll(".vim-tag");

      allTags.forEach(function (tag) {
        if (tag.textContent.toLowerCase() === keyPressed) {
          window.location.href = tag.dataset.href;
        }
      });

      this.toggleNormal();
      return;
    }

    //當 motion 兩個字才走這個模式
    if (
      this.currentMode === this.Mode.Motion &&
      document.querySelectorAll("a").length > this.tagChars.length
    ) {
      console.log("motion lastKeyPressed", this.lastKeyPressed);
      console.log("motion current", keyPressed);

      if (!this.lastKeyPressed) {
        //如果出現字表以外的字則回到 normal
        //console.log("firstCharArray", this.firstCharArray());
        if (this.firstCharArray().includes(keyPressed) === false) {
          this.toggleNormal();
          return;
        } else {
          let allTags = document.querySelectorAll(".vim-tag");
          allTags.forEach(function (tag) {
            if (tag.textContent[0].toLowerCase() !== keyPressed) {
              tag.parentNode.removeChild(tag);
            }

            //將第一個字變為紅色
            if (tag.textContent[0].toLowerCase() === keyPressed) {
              tag.innerHTML =
                '<span style="color: red;">' +
                tag.textContent.charAt(0) +
                "</span>" +
                tag.textContent.substring(1);
            }
          });
        }
      }

      //如果有字的話才執行
      if (this.lastKeyPressed) {
        let chars = this.lastKeyPressed + keyPressed;
        console.log("chars", chars);
        let allTags = document.querySelectorAll(".vim-tag");
        allTags.forEach(function (tag) {
          if (tag.textContent.toLowerCase() === chars) {
            window.location.href = tag.dataset.href;
          }
        });
        //萬一沒找到切回 Normal
        this.toggleNormal();
        return;
      }
    }

    // 任何模式按兩下的區域
    if (
      keyPressed === this.lastKeyPressed &&
      currentTime - this.lastKeyPressTime < 300
    ) {
      this.viGoTop(keyPressed);
    }

    // 按一下的區域
    this.viGoBottom(keyPressed);
    this.viDown(keyPressed);
    this.viFastDown(keyPressed);
    this.viUp(keyPressed);
    this.viFastUp(keyPressed);

    this.lastKeyPressTime = currentTime;
    this.lastKeyPressed = keyPressed;
  }

  init() {
    document.addEventListener("keydown", this.handleKeyDown.bind(this));
  }
}

const viNavigation = new ViNavigation();
viNavigation.init();
</script>



</body>
</html>
