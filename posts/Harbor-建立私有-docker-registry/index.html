<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 8.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/gg.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/gg.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/gg.png">
  <link rel="mask-icon" href="/images/gg.png" color="#222">
  <meta name="google-site-verification" content="J5sjnNRD2AYPWVE08_-8XO_8mBKRYD3NKVYRBCGMwQ8">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">



<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S5ZWC157GD"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-S5ZWC157GD');
</script>

<style>
    @font-face {
        /* font-family: "JasonHandwriting1-Regular"; */
/*
        src: url(https://cdn.jsdelivr.net/gh/max32002/JasonHandWritingFonts@20210716/webfont/JasonHandwriting1-Regular.woff2) format("woff2"), url(https://cdn.jsdelivr.net/gh/max32002/JasonHandWritingFonts@20210716/webfont/JasonHandwriting1-Regular.woff) format("woff");
		*/

        font-family: "ä¿æ–¹é«”11è™Ÿ";
        src: url(/fonts/Cubic_11_1.000_R.woff) format("woff")
    }
</style>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.blog.lasai.com.tw","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.json"};
  </script>

  <meta name="description" content="&nbsp;">
<meta property="og:type" content="article">
<meta property="og:title" content="Harbor å»ºç«‹ç§æœ‰ docker registry">
<meta property="og:url" content="https://www.blog.lasai.com.tw/posts/Harbor-%E5%BB%BA%E7%AB%8B%E7%A7%81%E6%9C%89-docker-registry/index.html">
<meta property="og:site_name" content="ğŸŒ¹ å–‡è³½çš„äºº Blog ğŸŒ¹">
<meta property="og:description" content="&nbsp;">
<meta property="og:locale" content="zh_TW">
<meta property="article:published_time" content="2021-06-28T18:49:47.000Z">
<meta property="article:modified_time" content="2025-02-19T09:29:19.093Z">
<meta property="article:author" content="ğŸŒ¹ å–‡è³½äºº ğŸŒ¹">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://www.blog.lasai.com.tw/posts/Harbor-%E5%BB%BA%E7%AB%8B%E7%A7%81%E6%9C%89-docker-registry/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>Harbor å»ºç«‹ç§æœ‰ docker registry | ğŸŒ¹ å–‡è³½çš„äºº Blog ğŸŒ¹</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-S5ZWC157GD"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-S5ZWC157GD');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <!-- google ad -->
  <!--
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1069539516107706"
     crossorigin="anonymous"></script>
  -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!--
  <div class="spell" ></div>
  <div class="ghost" style="display: none;"></div>
  <div class="noise"></div>
  <div class="noise2"></div>
  -->


  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ›å°èˆªæ¬„">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ğŸŒ¹ å–‡è³½çš„äºº Blog ğŸŒ¹</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">ğŸŒ¹ å–‡ä½å–‡è³½ ğŸŒ¹</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>çœŸå–‡è³½</a>

  </li>
        <li class="menu-item menu-item-map">

    <a href="/map/" rel="section"><i class="fa fa-map fa-fw"></i>å–‡è³½äººçš„å¥‡æ€ªç¾é£Ÿåœ°åœ–</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>é—œæ–¼å–‡è³½äºº</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>å–‡è³½çš„æ¨™ç±¤</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å–‡è³½äº‚å¯«</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœå°‹
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœå°‹..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://www.blog.lasai.com.tw/posts/Harbor-%E5%BB%BA%E7%AB%8B%E7%A7%81%E6%9C%89-docker-registry/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="ğŸŒ¹ å–‡è³½äºº ğŸŒ¹">
      <meta itemprop="description" content="ğŸŒ¹ å–‡è³½äººçš„ Blog ğŸŒ¹">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ğŸŒ¹ å–‡è³½çš„äºº Blog ğŸŒ¹">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Harbor å»ºç«‹ç§æœ‰ docker registry
        </h1>

        <div class="post-meta">
		
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">äº‚å¯«æ–¼</span>

              <time title="äº‚å…¥æ™‚é–“ï¼š2021-06-29 02:49:47" itemprop="dateCreated datePublished" datetime="2021-06-29T02:49:47+08:00">2021-06-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°æ–¼</span>
                <time title="ä¿®æ”¹æ™‚é–“ï¼š2025-02-19 17:29:19" itemprop="dateModified" datetime="2025-02-19T17:29:19+08:00">2025-02-19</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqusï¼š</span>
    
    <a title="disqus" href="/posts/Harbor-%E5%BB%BA%E7%AB%8B%E7%A7%81%E6%9C%89-docker-registry/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="posts/Harbor-å»ºç«‹ç§æœ‰-docker-registry/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="å»¢è©±å­—æ•¸">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">å»¢è©±å­—æ•¸ï¼š</span>
              <span>26k</span>
            </span>
            <span class="post-meta-item" title="æ‰€éœ€å‚·çœ¼æ™‚é–“">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">æ‰€éœ€å‚·çœ¼æ™‚é–“ &asymp;</span>
              <span>24 åˆ†é˜</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>&nbsp;</p>
<span id="more"></span>

<h3 id="Harbor-å®‰è£"><a href="#Harbor-å®‰è£" class="headerlink" title="Harbor å®‰è£"></a>Harbor å®‰è£</h3><p><a target="_blank" rel="noopener" href="https://ivanzz1001.github.io/records/post/docker/2018/04/09/docker-harbor-https">åƒè€ƒå¼·åœ‹äºº</a><br>æˆ–æ˜¯å¦ä¸€å€‹å¼·åœ‹äºº(<a target="_blank" rel="noopener" href="https://www.cnblogs.com/ExMan/p/11996944.html">https://www.cnblogs.com/ExMan/p/11996944.html</a>)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/goharbor/harbor/releases/download/v2.3.0/harbor-offline-installer-v2.3.0.tgz</span><br><span class="line">tar -xvf harbor-offline-installer-v2.3.0.tgz</span><br><span class="line">cd harbor</span><br><span class="line">cp harbor.yml.tmpl harbor.yml</span><br><span class="line">vim harbor.yml</span><br><span class="line"></span><br><span class="line">#æŠŠ https è¨»è§£æ‰</span><br><span class="line">#ä¸¦ä¸”æŠŠ hostname ç›´æ¥æ›æˆæ©Ÿå™¨çš„ ip</span><br><span class="line">hostname: 10.1.25.123</span><br><span class="line"></span><br><span class="line"> # https related config</span><br><span class="line"> #https:</span><br><span class="line">   # https port for harbor, default is 443</span><br><span class="line">   #port: 443</span><br><span class="line">   # The path of cert and key files for nginx</span><br><span class="line">   #certificate: /your/certificate/path</span><br><span class="line">   #private_key: /your/private/key/path</span><br><span class="line"></span><br><span class="line">./prepare --with-trivy --with-chartmuseum</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„! è¬ä¸€ä¹‹å‰æœ‰å®‰è£ registry å…ˆæŠŠä»–åœæ‰æˆ–æ˜¯ç§»é™¤ , ä¸ç„¶æœƒèµ·ä¸ä¾†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker container ls -a</span><br><span class="line">docker container rm ec1fadeecc80 5b5dfc3e0a31</span><br></pre></td></tr></table></figure>

<p>åˆ°æ­¤å¯ä»¥å…ˆçœ‹ä¸€ä¸‹çµæœåœ¨ chrome è¼¸å…¥ <code>10.1.25.123</code> å³å¯é€²å…¥ Harbor ç•«é¢<br>é è¨­ç™»å…¥çš„å¸³è™Ÿå¯†ç¢¼ç‚º <code>admin</code> <code>Harbor12345</code> æ³¨æ„ H æ˜¯å¤§å¯«<br>å»ºç«‹ä¸€å€‹åç¨±ç‚º test ç§æœ‰çš„å°ˆæ¡ˆ</p>
<p>æ¥è‘—ç¢ºä¿ server ä¸Š docker çš„ <code>daemon.json</code> å±¬æ€§ <code>insecure-registries</code> æœ‰æ­£ç¢º ip åŠ å…¥ , å› ç‚ºå…ˆå‰è¨­å®š harbor.yml ä½¿ç”¨çš„æ˜¯ 80 , æ­¤è™•è¦è¨­å®š 80<br>å¦å¤– client çš„ docker insecure-registries ä¹Ÿè¦åŠ å…¥æ­£ç¢ºçš„ ip åœ°å€<br>è©³ç´°èªªæ˜å¯ä»¥çœ‹<a target="_blank" rel="noopener" href="https://docs.docker.com/registry/insecure/">å®˜ç¶²</a></p>
<p>windows <code>C:\ProgramData\docker\config\daemon.json</code><br>linux <code>/etc/docker/daemon.json</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">        &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">        &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">        &quot;log-opts&quot;:&#123;</span><br><span class="line">                &quot;max-size&quot;: &quot;100m&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">        &quot;insecure-registries&quot;:[</span><br><span class="line">                &quot;10.1.25.123&quot;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ ä¿®æ”¹å¾Œéœ€è¦ restart docker , ä¸¦ä¸”è¦å†æ¬¡é–‹å•Ÿ harbor</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo service docker restart</span><br><span class="line">sudo docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>æœ€å¾Œé–‹ä¸€å€‹æ–°çš„ powershell or bash æ¸¬è©¦ç”¨ client ç™»å…¥ç§æœ‰çš„ registry æ‡‰è©²å¯ä»¥çœ‹åˆ° <code>Login Succeeded</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login http://10.1.25.123 --username admin --password Harbor12345</span><br></pre></td></tr></table></figure>
<p>è‹¥å¤±æ•—å‰‡æœƒçœ‹åˆ°è¨˜å¾—æª¢æŸ¥çœ‹çœ‹æ˜¯å¦ç‚º <code>insecure-registries</code> è¨­å®šéŒ¯èª¤ , <code>æ³¨æ„! å¦‚æœæ˜¯åœ¨ k8s æ•´åˆä¸Šçš„è©±æ¯å€‹ node éƒ½éœ€è¦è¨­å®š</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error response from daemon: Get https://10.1.25.123/v2/: dial tcp 10.1.25.123:443: connect: connection refused</span><br></pre></td></tr></table></figure>

<p>æ‰“æ¨™ç±¤åœ¨é€™å€‹ image ä¸Š , ä¸¦ä¸” push</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag nginx:latest 10.1.25.123/test/nginx:latest</span><br><span class="line">docker push 10.1.25.123/test/nginx:latest</span><br></pre></td></tr></table></figure>

<h3 id="k8s-æ•´åˆ"><a href="#k8s-æ•´åˆ" class="headerlink" title="k8s æ•´åˆ"></a>k8s æ•´åˆ</h3><p>è©³ç´°èªªæ˜å¯åƒè€ƒ<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/">å®˜ç¶²</a><br>çœ‹ç¶²è·¯ä¸ŠæŒ‡å®šæª”æ¡ˆéƒ½ç”¨é€™æ¨£ <code>~/.docker/config.json</code> , ä½†æ˜¯æœƒç‚¸ Error , ä¸æ›‰å¾—ç‚ºå•¥ , æ‰€ä»¥æ”¹æˆ $HOME é¨™çœ‹çœ‹æ‰é</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic regcred --from-file=.dockerconfigjson=$HOME/.docker/config.json --type=kubernetes.io/dockerconfigjson</span><br></pre></td></tr></table></figure>

<p>æˆ–æ˜¯ç›´æ¥ç”¨é€™æ¨£æ‡‰è©²éƒ½æœƒå»ºç«‹å‡ºä¸€æ¨£çš„çµæœ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry regcred --docker-server=10.1.25.123  \</span><br><span class="line">--docker-username=admin \</span><br><span class="line">--docker-password=Harbor12345</span><br></pre></td></tr></table></figure>

<p>æ¥è‘—å°å‡º secret regcred çœ‹çœ‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret regcred --output=yaml</span><br></pre></td></tr></table></figure>

<p>æœƒé•·é€™æ¨£</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  .dockerconfigjson: ewoJImF1dGhzIjogewoJCSIxMC4xLjMxxx...</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: &quot;2021-06-20T07:23:34Z&quot;</span><br><span class="line">  name: regcred</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &quot;3050890&quot;</span><br><span class="line">  uid: 9b48e55e-89dc-4b61-b9ee-749cc47d9ae9</span><br><span class="line">type: kubernetes.io/dockerconfigjson</span><br></pre></td></tr></table></figure>

<p>æœ€å¾Œå»ºç«‹ <code>Pod</code> çœ‹çœ‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: private-reg</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: private-reg-container</span><br><span class="line">    image: 10.1.25.123/test/nginx:latest</span><br><span class="line">  imagePullSecrets:</span><br><span class="line">  - name: regcred</span><br></pre></td></tr></table></figure>

<h3 id="k8s-æ•´åˆ-net-core"><a href="#k8s-æ•´åˆ-net-core" class="headerlink" title="k8s æ•´åˆ .net core"></a>k8s æ•´åˆ .net core</h3><p>å¯ä»¥åƒè€ƒ<a target="_blank" rel="noopener" href="https://www.cnblogs.com/sheng-jie/p/10591794.html">é€™ç¯‡å¼·åœ‹äºº</a></p>
<h4 id="Pod-èµ·æ‰‹å¼"><a href="#Pod-èµ·æ‰‹å¼" class="headerlink" title="Pod èµ·æ‰‹å¼"></a>Pod èµ·æ‰‹å¼</h4><p>æ–°å¢ <code>HelloWorldController</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[Route( &quot;api/[controller]&quot; )]</span><br><span class="line">[ApiController]</span><br><span class="line">public class HelloWorldController : ControllerBase</span><br><span class="line">&#123;</span><br><span class="line">    [HttpGet]</span><br><span class="line">    public string Get()</span><br><span class="line">    &#123;</span><br><span class="line">        string result = &quot;&quot;;</span><br><span class="line">        string HostName = Dns.GetHostName();</span><br><span class="line">        Console.WriteLine( &quot;Host Name of machine =&quot; + HostName );</span><br><span class="line">        result += &quot;Host Name of machine =&quot; + HostName + Environment.NewLine;</span><br><span class="line">        IPAddress[] ipaddress = Dns.GetHostAddresses( HostName );</span><br><span class="line">        Console.Write( &quot;IPv4 of Machine is &quot; );</span><br><span class="line">        result += &quot;IPv4 of Machine is &quot; + Environment.NewLine;</span><br><span class="line">        foreach (IPAddress ip4 in ipaddress.Where( ip =&gt; ip.AddressFamily == System.Net.Sockets.AddressFamily.InterNetwork ))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine( ip4.ToString() );</span><br><span class="line">            result += ip4.ToString() + Environment.NewLine;</span><br><span class="line">        &#125;</span><br><span class="line">        Console.Write( &quot;IPv6 of Machine is &quot; );</span><br><span class="line">        result += &quot;IPv6 of Machine is &quot; + Environment.NewLine;</span><br><span class="line">        foreach (IPAddress ip6 in ipaddress.Where( ip =&gt; ip.AddressFamily == System.Net.Sockets.AddressFamily.InterNetworkV6 ))</span><br><span class="line">        &#123;</span><br><span class="line">            Console.WriteLine( ip6.ToString() );</span><br><span class="line">            result += ip6.ToString() + Environment.NewLine;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>ç‰¹åˆ¥æ³¨æ„ <code>Startup</code> å…§çš„ <code>Configure</code> æ–¹æ³• , éœ€è¦æŠŠ UseHttpsRedirection è¨»è§£æ‰ , ä¸ç„¶æœƒå°å‘éŒ¯èª¤çš„ç¶²å€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//app.UseHttpsRedirection();</span><br></pre></td></tr></table></figure>


<p>æ–°å¢ <code>DockerFile</code> ä¸¦ä¸”æŠŠæª”æ¡ˆè¨­å®šç‚º <code>Always Copy</code><br>è¨­å®šæš´éœ²çš„ PORT , æ³¨æ„é€™å€‹ <code>ENV ASPNETCORE_URLS=http://+:80;https://+:443</code> ä¸€å®šè¦è¨­å®š , ä¸ç„¶æœƒæ‰¾ä¸åˆ°ä½ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM mcr.microsoft.com/dotnet/sdk:5.0 AS build</span><br><span class="line">WORKDIR /app</span><br><span class="line">COPY . .</span><br><span class="line">ENV ASPNETCORE_URLS=http://+:80;https://+:443</span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">EXPOSE 443</span><br><span class="line">ENTRYPOINT [&quot;dotnet&quot;, &quot;HelloWorldKubernetes.dll&quot;]</span><br></pre></td></tr></table></figure>

<p>åˆ‡æ›åˆ° bin\Debug ç›®éŒ„åº•ä¸‹é€²è¡Œç·¨è­¯ , ç”¨ docker è·‘çœ‹çœ‹çµæœæ˜¯å¦æ­£ç¢º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker build -t helloworldk8s .</span><br><span class="line">docker run --name helloworldk8s -d -p 5000:80 -p 5001:443  helloworldk8s:latest</span><br></pre></td></tr></table></figure>

<p>å…ˆç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹çœ‹æœ‰ç„¡æ­£ç¢ºå•Ÿå‹• container è¬ä¸€æ²’å•Ÿå‹•åŠ ä¸Š <code>-a</code> åƒæ•¸çœ‹çœ‹ç™¼ç”Ÿå•¥éŒ¯èª¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker container ls</span><br><span class="line"></span><br><span class="line">docker container ls -a</span><br></pre></td></tr></table></figure>

<p>é–‹å•Ÿ chrome æ¸¬è©¦<br><code>https://localhost:5001/api/helloworld</code><br><code>http://localhost:5000/api/helloworld</code></p>
<p>æ‰“æ¨™ç±¤åˆ°è‡ªå·±ç§æœ‰çš„ Harbor Registry ä¸¦ä¸”æ¨é€ä¸Šå»</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag helloworldk8s:latest 10.1.25.123/test/helloworldk8s:latest</span><br><span class="line">docker push 10.1.25.123/test/helloworldk8s:latest</span><br></pre></td></tr></table></figure>

<p>åœ¨ master ç¯€é» pull image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker pull 10.1.25.123/test/helloworldk8s:latest</span><br><span class="line">docker images</span><br><span class="line">#REPOSITORY                           TAG            IMAGE ID       CREATED          SIZE</span><br><span class="line">#10.1.25.123/test/helloworldk8s       latest         8d030c225a2a   18 minutes ago   635MB</span><br></pre></td></tr></table></figure>

<p>å»ºç«‹ yaml æª” , å¯ä»¥åƒè€ƒ[å¾®è»Ÿé€™ç¯‡]ä¾†ç·¨(<a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/architecture/containerized-lifecycle/design-develop-containerized-apps/build-aspnet-core-applications-linux-containers-aks-kubernetes">https://docs.microsoft.com/en-us/dotnet/architecture/containerized-lifecycle/design-develop-containerized-apps/build-aspnet-core-applications-linux-containers-aks-kubernetes</a>)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim private-reg-pod.yaml</span><br><span class="line">kubectl apply -f private-reg-pod.yaml</span><br></pre></td></tr></table></figure>

<p><code>private-reg-pod.yaml</code> å…§å®¹å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: private-reg</span><br><span class="line">  labels:</span><br><span class="line">	app: private-reg</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: private-reg-container</span><br><span class="line">    image: 10.1.25.123/test/helloworldk8s:latest</span><br><span class="line">    ports:</span><br><span class="line">      - containerPort: 80</span><br><span class="line">        protocol: TCP</span><br><span class="line">    env:</span><br><span class="line">      - name: ASPNETCORE_URLS</span><br><span class="line">        value: http://+:80</span><br><span class="line">  imagePullSecrets:</span><br><span class="line">  - name: regcred</span><br></pre></td></tr></table></figure>


<p>æŸ¥è©¢ç›®å‰ pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po</span><br><span class="line">#NAME          READY   STATUS    RESTARTS   AGE     IP            NODE</span><br><span class="line">#private-reg   1/1     Running   0          5m45s   10.244.1.87   node02</span><br></pre></td></tr></table></figure>

<p>è¬ä¸€æœ‰å•é¡Œ å¯ä»¥ç”¨ <code>describe</code> é™¤éŒ¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe po private-reg</span><br><span class="line"></span><br><span class="line">#æ­£å¸¸çš„è©±æœƒåƒæ˜¯ä¸‹é¢é€™æ¨£</span><br><span class="line">#Events:</span><br><span class="line">#  Type    Reason     Age   From               Message</span><br><span class="line">#  ----    ------     ----  ----               -------</span><br><span class="line">#  Normal  Scheduled  20s   default-scheduler  Successfully assigned default/private-reg to node02</span><br><span class="line">#  Normal  Pulling    19s   kubelet            Pulling image &quot;10.1.25.123/test/helloworldk8s:latet&quot;</span><br><span class="line">#  Normal  Pulled     2s    kubelet            Successfully pulled image &quot;10.1.25.123/test/helloworldk8s:latest&quot; in 17.048779767s</span><br><span class="line">#  Normal  Created    1s    kubelet            Created container private-reg-container</span><br><span class="line">#  Normal  Started    1s    kubelet            Started container private-reg-container</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥è·³é€²å» node è£¡é¢çœ‹çœ‹ docker ç‹€æ³</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker container ls</span><br><span class="line">#CONTAINER ID   IMAGE                            COMMAND                  CREATED          STATUS          PORTS     NAMES</span><br><span class="line">#ae35c6069640   10.1.25.123/test/helloworldk8s   &quot;dotnet HelloWorldKuâ€¦&quot;   23 minutes ago   Up 23 minutes             k8s_private...</span><br></pre></td></tr></table></figure>


<p>æ¥è‘—å¯ä»¥åœ¨ master ç”¨ curl æ¸¬è©¦</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl 10.244.1.87/api/helloworld</span><br></pre></td></tr></table></figure>

<p>æˆ–æ˜¯è·³å…¥ node æ¸¬è©¦ , é€™å€‹å…©æ§“ç¬¦è™Ÿ <code>--</code> è¡¨ç¤ºçµå°¾ , å¾Œé¢æ¥ linux å‘½ä»¤ , å› ç‚º dotnet core çš„é è¨­ shell æ˜¯ç”¨ bash , æ‰€ä»¥å¯« &#x2F;bin&#x2F;bash , å…¶ä»–å®¹å™¨æœ‰å¯èƒ½åªæœ‰ sh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it private-reg -- /bin/bash</span><br><span class="line"></span><br><span class="line">#è·³é€²å»å¾Œæœƒé•·é€™æ¨£ , æ¥è‘—åŸ·è¡Œ curl æ¸¬çœ‹çœ‹</span><br><span class="line">root@private-reg:/app# curl localhost/api/helloworld</span><br></pre></td></tr></table></figure>

<p>é‚„å¯ä»¥ç”¨ç°¡å–®ç²—æš´çš„ k8s port-forward åœ¨ master ä¾†æ¸¬çœ‹çœ‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:8087/api/helloworld</span><br></pre></td></tr></table></figure>

<p>æˆ–æ˜¯ç›´æ¥ç”¨ NodePort</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose pod private-reg --name private-reg --type=NodePort</span><br></pre></td></tr></table></figure>

<h4 id="Deployment-Lab"><a href="#Deployment-Lab" class="headerlink" title="Deployment Lab"></a>Deployment Lab</h4><p>å°‡ <code>Pod</code> æ”¹æˆä½ˆç½² <code>Deployment</code> , æœ‰çš„æ›¸ä¸Šæˆ–æ˜¯è³‡æ–™æœƒå¯«ç”¨ <code>ReplicaSet</code> , å¯¦éš›é‹ç”¨ä¸Šæœƒç›´æ¥ä½¿ç”¨ <code>Deployment</code> è®“ä»–é€²è¡Œè‡ªå‹•èª¿åº¦</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: asp-net-core-helloworld-k8s</span><br><span class="line">spec:</span><br><span class="line">  replicas: 4</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: asp-net-core-helloworld-k8s</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: asp-net-core-helloworld-k8s</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: asp-net-core-helloworld-k8s</span><br><span class="line">        image: 10.1.25.123/test/helloworldk8s:latest</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        - containerPort: 443</span><br><span class="line">        env:</span><br><span class="line">        - name: ASPNETCORE_URLS</span><br><span class="line">          value: http://+:80;https://+:443</span><br><span class="line">        - name: ASPNETCORE_ENVIRONMENT</span><br><span class="line">          value: Development</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: regcred</span><br></pre></td></tr></table></figure>

<p>æœ¬ä¾†æ²’ç¡é£½å°‘è¨­å®š <code>ASPNETCORE_ENVIRONMENT</code> , æ¸¬è©¦çš„æ™‚å€™ç™¼ç¾ swagger ä¸€ç›´æ‰“ä¸é–‹ , è¶…ç„¡è¨€<br>ç‰¹åˆ¥æ³¨æ„åˆ° , å› ç‚º asp.net core é è¨­æ˜¯åªæœ‰ <code>IsDevelopment</code> æ‰æœƒé–‹å•Ÿ , æ‰€ä»¥éœ€è¦åŠ å…¥ <code>ASPNETCORE_ENVIRONMENT</code> å€å¡Š<br>å¯ä»¥çœ‹<a target="_blank" rel="noopener" href="https://andrewlock.net/deploying-asp-net-core-applications-to-kubernetes-part-5-setting-environment-variables-in-a-helm-chart/">ASP.NET CORE in Action ä½œè€…çš„æ–‡ç« æœ‰èªªæ˜</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void Configure( IApplicationBuilder app, IWebHostEnvironment env )</span><br><span class="line">&#123;</span><br><span class="line">	if (env.IsDevelopment())</span><br><span class="line">	&#123;</span><br><span class="line">		app.UseDeveloperExceptionPage();</span><br><span class="line">		app.UseSwagger();</span><br><span class="line">		app.UseSwaggerUI( c =&gt; c.SwaggerEndpoint( &quot;/swagger/v1/swagger.json&quot;, &quot;HelloWorldKubernetes v1&quot; ) );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	//.....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŸ·è¡Œä½ˆç½² <code>asp-net-core-helloworld-k8s.yaml</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k apply -f asp-net-core-helloworld-k8s.yaml</span><br></pre></td></tr></table></figure>

<p>ç”¨ä¹‹å‰å®‰è£çš„ <code>tree</code> æŸ¥çœ‹çœ‹ <code>Deployment</code> çš„éšå±¤é—œä¿‚ , å¯ä»¥ç™¼ç¾å…¶å¯¦å¾Œé¢æœ‰ <code>ReplicaSet</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">k tree deployment asp-net-core-helloworld-k8s</span><br><span class="line">NAMESPACE  NAME                                                    READY  REASON  AGE</span><br><span class="line">default    Deployment/asp-net-core-helloworld-k8s                  -              3h42m</span><br><span class="line">default    â”œâ”€ReplicaSet/asp-net-core-helloworld-k8s-66f969cb87   -              3h42m</span><br><span class="line">default    â””â”€ReplicaSet/asp-net-core-helloworld-k8s-7ff974f489   -              46m</span><br><span class="line">default      â”œâ”€Pod/asp-net-core-helloworld-k8s-7ff974f489-bcj86  True           46m</span><br><span class="line">default      â”œâ”€Pod/asp-net-core-helloworld-k8s-7ff974f489-fnntp  True           46m</span><br><span class="line">default      â”œâ”€Pod/asp-net-core-helloworld-k8s-7ff974f489-j9s6s  True           46m</span><br><span class="line">default      â””â”€Pod/asp-net-core-helloworld-k8s-7ff974f489-l9j5f  True           46m</span><br></pre></td></tr></table></figure>

<p>æŸ¥çœ‹çœ‹ ReplicaSet ç¸®å¯«ç‚º rs , å¯ä»¥ç”¨ <code>k api-resources</code> ä¾†æŸ¥è©¢ç¸®å¯«</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">k get rs</span><br><span class="line">#NAME                                     DESIRED   CURRENT   READY   AGE</span><br><span class="line">#asp-net-core-helloworld-k8s-66f969cb87   0         0         0       3h52m</span><br><span class="line">#asp-net-core-helloworld-k8s-7ff974f489   4         4         4       56m</span><br></pre></td></tr></table></figure>

<p>æŸ¥ç›®å‰ pods</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k get po -o wide</span><br><span class="line"></span><br><span class="line">#NAME                                           READY   STATUS    RESTARTS   AGE     IP             NODE</span><br><span class="line">#asp-net-core-helloworld-k8s-67cb6f48cd-6xxd7   1/1     Running   0          101s    10.244.1.99    node02</span><br><span class="line">#asp-net-core-helloworld-k8s-67cb6f48cd-nlhlw   1/1     Running   0          101s    10.244.1.100   node02</span><br></pre></td></tr></table></figure>

<p>åœ¨ cluster å…§ç”¨ curl å‘¼å«çœ‹çœ‹æ˜¯å¦æˆåŠŸ , é€™é‚Šé‚„æœ‰å€‹ debug çš„å¥½æ³•å­å°±æ˜¯åŠ ä¸Š <code>--dump-header -</code> é€™æ¨£å¯ä»¥çœ‹åˆ° header æ›´å¥½ debug</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl 10.244.1.99:80/api/helloworld</span><br><span class="line">curl 10.244.1.100:80/api/helloworld</span><br><span class="line"></span><br><span class="line">#æ¸¬å€‹æ²’çµæœçš„</span><br><span class="line">curl --dump-header - http://10.244.1.112:80</span><br><span class="line">HTTP/1.1 404 Not Found</span><br><span class="line">Date: Wed, 30 Jun 2021 07:35:31 GMT</span><br><span class="line">Server: Kestrel</span><br><span class="line">Content-Length: 0</span><br></pre></td></tr></table></figure>

<p>æŸ¥ deployment ä¹Ÿå¯ä»¥ç”¨ deploy ç­‰åƒ¹ç¸®å¯«</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">k get deployments</span><br><span class="line">k get deploy</span><br><span class="line">#NAME                          READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">#asp-net-core-helloworld-k8s   2/2     2            2           3m49s</span><br></pre></td></tr></table></figure>

<p>æš´éœ²æˆ service <code>NodePort</code><br>åœ¨ k8s å…§ <code>ClusterIP</code> ç‚ºå…§éƒ¨é€šä¿¡è€Œ <code>NodePort</code> ç‚ºæš´éœ²çµ¦å¤–éƒ¨å¯ä»¥é€²è¡Œè¨ªå•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k expose deployment asp-net-core-helloworld-k8s --name asp-net-core-helloworld-k8s --type=NodePort</span><br></pre></td></tr></table></figure>

<p>æœ€å¾ŒæŸ¥çœ‹çœ‹çµæœ , å¯ä»¥çœ‹åˆ° cluster å…§éƒ¨è¨ªå•æ˜¯ 10.96.165.130 , è€Œå¤–éƒ¨å‰‡ä½¿ç”¨ master æ©Ÿå™¨çš„ ip åŠ ä¸Š 31956</p>
<p>http <code>http://10.1.25.123:31956</code><br>https <code>https://10.1.25.123:32418</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k get svc</span><br><span class="line">#NAME                          TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">#asp-net-core-helloworld-k8s   NodePort       10.96.165.130    &lt;none&gt;        80:31956/TCP,443:32418/TCP   3h4m</span><br></pre></td></tr></table></figure>

<p>è¬ä¸€æƒ³åˆªé™¤å‰‡ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k delete deployments asp-net-core-helloworld-k8s</span><br><span class="line">k delete service asp-net-core-helloworld-k8s</span><br></pre></td></tr></table></figure>

<h4 id="HPA-Lab"><a href="#HPA-Lab" class="headerlink" title="HPA Lab"></a>HPA Lab</h4><p>å˜—è©¦åšåš HPA çš„ lab , çœ‹æ›¸ä¸Šå¯«çš„å«ç³Š , æ±è¥¿ä¸€ç›´æ²’èµ·ä¾† , æŸ¥äº†ä¸‹æ‰ç™¼ç¾è¦å®‰è£ <code>Metric-Server</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">k describe hpa asp-net-core-helloworld-k8s</span><br><span class="line">#</span><br><span class="line">#Type     Reason                        Age                From                       Message</span><br><span class="line">#----     ------                        ----               ----                       -------</span><br><span class="line">#Warning  FailedGetResourceMetric       1s (x8 over 107s)  horizontal-pod-autoscaler  failed to get cpu utilization: unable to get metrics for resource cpu: unable to fetch metrics from resource metrics API: the server could not find the requested resource (get pods.metrics.k8s.io)</span><br><span class="line">#Warning  FailedComputeMetricsReplicas  1s (x8 over 107s)  horizontal-pod-autoscaler  invalid metrics (1 invalid out of 1), first error is: failed to get cpu utilization: unable to get metrics for resource cpu: unable to fetch metrics from resource metrics API: the server could not find the requested resource (get pods.metrics.k8s.io)</span><br></pre></td></tr></table></figure>

<p>å®‰è£å¯ä»¥åƒè€ƒé€™å€‹<a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/metrics-server">å®˜æ–¹æ–‡ä»¶</a><br>ç›´æ¥ç…§è‘—æ–‡ä»¶åšé‚„æ˜¯æœƒé™£äº¡ , è¦ç‰¹åˆ¥æ³¨æ„ <code>Requirements</code> é€™æ®µå¯«çš„å…§å®¹ , æˆ‘çš„å•é¡Œæ˜¯è¦åŠ ä¸Š <code>kubelet-insecure-tls</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#Requirements å®Œå…¨æ²’å•é¡Œçš„è©±å®˜æ–¹ä½œæ³•</span><br><span class="line">#kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line"></span><br><span class="line">#æˆ‘çš„ä½œæ³•</span><br><span class="line">wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.5.0/components.yaml</span><br><span class="line">vim components.yaml</span><br><span class="line">#æ‰¾åˆ° Deployment åŠ å…¥ kubelet-insecure-tls åƒæ•¸</span><br><span class="line">#spec:</span><br><span class="line">#  containers:</span><br><span class="line">#  - args:</span><br><span class="line">#	- --cert-dir=/tmp</span><br><span class="line">#	- --secure-port=443</span><br><span class="line">#	- --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">#	- --kubelet-use-node-status-port</span><br><span class="line">#	- --metric-resolution=15s</span><br><span class="line">#	- --kubelet-insecure-tls</span><br><span class="line">#	image: k8s.gcr.io/metrics-server/metrics-server:v0.5.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#é©—è­‰æ˜¯å¦æˆåŠŸ</span><br><span class="line">k get po,deployment -n kube-system</span><br></pre></td></tr></table></figure>

<p>å®‰è£å¥½ä»¥å¾Œå¯ä»¥èª¿æ•´ <code>Deployment</code> çš„ <code>resources</code> å€å¡Šä¾†é™å®šè³‡æºä½¿ç”¨ , æ³¨æ„ä½¿ç”¨ <code>HorizontalPodAutoscaler</code> å‰éœ€è¦å…ˆå®šç¾© <code>Deployment</code><br>è©³ç´°èªªæ˜å¯ä»¥çœ‹é€™å€‹<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale/">å®˜ç¶²æ–‡ä»¶</a></p>
<p>asp-net-core-helloworld-k8s.yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: asp-net-core-helloworld-k8s</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: asp-net-core-helloworld-k8s</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: asp-net-core-helloworld-k8s</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: asp-net-core-helloworld-k8s</span><br><span class="line">        image: 10.1.25.123/test/helloworldk8s:latest</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        - containerPort: 443</span><br><span class="line">        env:</span><br><span class="line">        - name: ASPNETCORE_URLS</span><br><span class="line">          value: http://+:80;https://+:443</span><br><span class="line">        - name: ASPNETCORE_ENVIRONMENT</span><br><span class="line">          value: Development</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 500m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 200m</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: regcred</span><br></pre></td></tr></table></figure>

<p>asp-net-core-helloworld-k8s-hpa.yaml<br>é™åˆ¶ 50% cpu ä½¿ç”¨ç‡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: autoscaling/v1</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: asp-net-core-helloworld-k8s</span><br><span class="line">spec:</span><br><span class="line">  scaleTargetRef:</span><br><span class="line">    apiVersion: apps/v1</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: asp-net-core-helloworld-k8s</span><br><span class="line">  minReplicas: 1</span><br><span class="line">  maxReplicas: 10</span><br><span class="line">  targetCPUUtilizationPercentage: 50</span><br></pre></td></tr></table></figure>

<p>æœ€å¾Œæ˜¯ä½ˆç½² HPA</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k apply -f asp-net-core-helloworld-k8s.yaml</span><br><span class="line">k apply -f asp-net-core-helloworld-k8s-hpa.yaml</span><br></pre></td></tr></table></figure>

<p>å®‰è£ apache ab , å› ç‚ºé è¨­æœƒæœ‰é™åˆ¶ , é€™é‚ŠæŠŠé™åˆ¶è§£é–‹ , æ¥è‘—æ¨¡æ“¬å¤šäºº request æˆ‘å€‘çš„ api</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#è¬ä¸€æ˜¯è¢«æ‹”å…‰çš„ ubuntu æ‰å®‰è£ä»¥ä¸‹å‘½ä»¤</span><br><span class="line">#apt upgrade</span><br><span class="line">#apt update</span><br><span class="line">#apt list --upgradable</span><br><span class="line">#apt-get install iputils-ping</span><br><span class="line">#apt-get install -y net-tools</span><br><span class="line"></span><br><span class="line">#æ™®é€š ubuntu æ‡‰è©²ç›´æ¥å¯ä»¥å®‰è£ ab</span><br><span class="line">sudo apt-get install apache2-utils</span><br><span class="line">ulimit -a</span><br><span class="line">ulimit -n 204800</span><br><span class="line"></span><br><span class="line">#æŸ¥ç›®å‰ ClusterIP</span><br><span class="line">k get svc</span><br><span class="line">#NAME                          TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">#asp-net-core-helloworld-k8s   NodePort       10.96.165.130    &lt;none&gt;        80:31956/TCP,443:32418/TCP   7d2h</span><br><span class="line"></span><br><span class="line">#æ¸¬è©¦æ¨¡æ“¬å¤šäººåŒæ™‚ request  , æ³¨æ„é€™é‚Šä¸ç®¡æ˜¯æ‰“ cluster-id æˆ–æ˜¯ç”¨å°å¤–çš„ port éƒ½å¯ä»¥é”åˆ°åŒæ¨£æ•ˆæœ</span><br><span class="line">ab -r -c 2000 -n 204800 http://10.96.165.130/api/helloworld</span><br><span class="line"></span><br><span class="line">#æ‡¶å¾—å®‰è£ ab çš„è©±ç›´æ¥ç”¨ curl + while ä¹Ÿå¯ä»¥æ¸¬</span><br><span class="line">while true; do curl http://10.96.165.130/api/helloworld; done</span><br></pre></td></tr></table></figure>


<p>æŸ¥çœ‹ HPA æ˜¯å¦æœ‰ç”Ÿæ•ˆ , æ³¨æ„é€™é‚Š TARGETS è¶…éäº†ç¸½ä½¿ç”¨é‡ 50% , REPLICAS ä¹Ÿæ“´å……åˆ° 10 å€‹ , è‡³æ­¤å°±å®Œæˆäº†æ•´å€‹è‡ªå‹•æ“´å®¹<br>æœ€å¾Œç­‰åˆ° ab æŠŠ request æ‰“å®Œä»¥å¾Œ , æœƒè‡ªå‹•ç¸®å®¹é è¨­æ™‚é–“æ˜¯ 5 åˆ†é˜ , è¦èª¿æ•´çš„è©±åƒæ•¸ç‚º <code>--horizontal-pod-autoscaler-downscale-stabilization</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#æŸ¥ hpa</span><br><span class="line">k get hpa</span><br><span class="line">#NAME                          REFERENCE                                TARGETS    MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">#asp-net-core-helloworld-k8s   Deployment/asp-net-core-helloworld-k8s   146%/50%   1         10        10         78m</span><br><span class="line"></span><br><span class="line">#æŸ¥ pod</span><br><span class="line">k get po</span><br><span class="line"></span><br><span class="line">#ä¹Ÿå¯ä»¥ç”¨ sql plugin çš„æ–¹å¼æ’ˆ</span><br><span class="line">#k sql get po where &quot;name like &#x27;%asp%&#x27;&quot;</span><br><span class="line"></span><br><span class="line">#NAME                                           READY   STATUS             RESTARTS   AGE</span><br><span class="line">#asp-net-core-helloworld-k8s-5766cd7cc5-4x452   1/1     Running            0          92s</span><br><span class="line">#asp-net-core-helloworld-k8s-5766cd7cc5-8kxw6   1/1     Running            0          107s</span><br><span class="line">#asp-net-core-helloworld-k8s-5766cd7cc5-gtcn9   1/1     Running            0          62s</span><br><span class="line">#asp-net-core-helloworld-k8s-5766cd7cc5-js4sj   1/1     Running            0          79m</span><br><span class="line">#asp-net-core-helloworld-k8s-5766cd7cc5-lw4b2   1/1     Running            0          62s</span><br><span class="line">#asp-net-core-helloworld-k8s-5766cd7cc5-m4stc   1/1     Running            0          62s</span><br><span class="line">#asp-net-core-helloworld-k8s-5766cd7cc5-mpblz   1/1     Running            0          107s</span><br><span class="line">#asp-net-core-helloworld-k8s-5766cd7cc5-rlnhs   1/1     Running            0          107s</span><br><span class="line">#asp-net-core-helloworld-k8s-5766cd7cc5-v6m2x   1/1     Running            0          62s</span><br><span class="line">#asp-net-core-helloworld-k8s-5766cd7cc5-zcptc   1/1     Running            0          62s</span><br></pre></td></tr></table></figure>

<h4 id="è¨­å®š-dns"><a href="#è¨­å®š-dns" class="headerlink" title="è¨­å®š dns"></a>è¨­å®š dns</h4><p>ç¶²è·¯éƒ¨åˆ†é™¤äº†è¨­å®š hosts ä¹‹å¤–é‚„æœ‰ dnsPolicy å¯ä»¥è¨­å®š , åˆ†åˆ¥ç‚º <code>Default</code> , <code>ClusterFirst</code> , <code>ClusterFirstWithHostNet</code> , <code>None</code><br>å› ç‚ºåœ¨å…§ç¶²è£¡æœ‰è‡ªå·±çš„ dns server ä»¥æˆ‘ç’°å¢ƒä½¿ç”¨ ubuntu ç‚ºä¾‹ , æŸ¥è©¢çœ‹çœ‹ç›®å‰ç”¨å•¥ dns ip</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#æ‡‰ä»¥ netplan å…§çš„ç‚ºæº–</span><br><span class="line">cat /etc/netplan/00-network-manager-all.yaml</span><br><span class="line">cat /run/systemd/resolve/resolv.conf</span><br><span class="line">cat /etc/resolv.conf</span><br></pre></td></tr></table></figure>

<p>æ¥è‘—è¨­å®šæ­£ç¢ºçš„ dns</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: asp-net-core-helloworld-k8s</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: asp-net-core-helloworld-k8s</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: asp-net-core-helloworld-k8s</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: asp-net-core-helloworld-k8s</span><br><span class="line">        image: 10.1.25.123/test/asp-net-core-helloworld-k8s:latest</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">      dnsPolicy: ClusterFirstWithHostNet</span><br><span class="line">      dnsConfig:</span><br><span class="line">        nameservers:</span><br><span class="line">          - 10.1.25.7</span><br><span class="line">        searches:</span><br><span class="line">          - xxx.com.tw</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: regcred</span><br></pre></td></tr></table></figure>

<p>æœ€å¾Œè·³é€²å»çœ‹çœ‹ , å¯ä»¥çœ‹åˆ° k8s å¤šæŠŠ dns è£œé€²å»äº† , åŸæœ¬åªæœ‰ 10.96.0.10 é€™å€‹ nameserver , è·Ÿé€™ä¸² search default.svc.cluster.local svc.cluster.local cluster.local<br>ç¾åœ¨å¤šè£œé€²äº†ä¹‹å‰æˆ‘å€‘åœ¨ deployment å…§è¨­å®šçš„å€å¡Š </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">k exec -it asp-net-core-helloworld-k8s-7cfc8db5f6-bk2j8 -- sh</span><br><span class="line">cat /etc/resolv.conf</span><br><span class="line"></span><br><span class="line">#nameserver 10.96.0.10</span><br><span class="line">#nameserver 10.1.25.7</span><br><span class="line">#search default.svc.cluster.local svc.cluster.local cluster.local xxx.com.tw</span><br><span class="line">#options ndots:5</span><br></pre></td></tr></table></figure>
<p>æœ€å¾Œå¯ä»¥åƒè€ƒ<a target="_blank" rel="noopener" href="https://gist.github.com/superseb/f6894ddbf23af8e804ed3fe44dd48457">é€™ç¯‡ä½›å¿ƒè€å¤–</a>æœ‰å…¶ä»–è§£æ³•</p>
<h4 id="hosts-è¨­å®š"><a href="#hosts-è¨­å®š" class="headerlink" title="hosts è¨­å®š"></a>hosts è¨­å®š</h4><p>é™¤äº† dns ä»¥å¤–å¯èƒ½æœƒæƒ³è¦åœ¨è‡ªå·±çš„ container å…§ä½¿ç”¨ hosts , k8s æœ‰ hostalias é€™å€‹æ±æ±å¯ä»¥ä½¿ç”¨<br>å…ˆæŸ¥è‡ªå·±æœ‰å•¥ hosts éœ€è¦è£œ<br>linux <code>/etc/hosts</code><br>windows <code>C:\Windows\System32\drivers\etc\hosts</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: asp-net-core-helloworld-k8s</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: asp-net-core-helloworld-k8s</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: asp-net-core-helloworld-k8s</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: asp-net-core-helloworld-k8s</span><br><span class="line">        image: 10.1.25.123/test/asp-net-core-helloworld:latest</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">      hostAliases:</span><br><span class="line">      - ip: &quot;10.1.17.46&quot;</span><br><span class="line">        hostnames:</span><br><span class="line">        - &quot;ggyy.com.tw&quot;</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: regcred</span><br></pre></td></tr></table></figure>

<h4 id="liveness-æ¢é‡"><a href="#liveness-æ¢é‡" class="headerlink" title="liveness æ¢é‡"></a>liveness æ¢é‡</h4><p>æ¥è‘—ä¾†è¨­å®š liveness æ¢é‡ , ä¿®æ”¹ Deployment , å›ºå®šæ¯ 10 ç§’æˆ³ä¸€æ¬¡çœ‹çœ‹æœ‰æ²’æœ‰æ´» , å•Ÿå‹•æ™‚çµ¦ä»–å€‹ç·©è¡æ™‚é–“ 5 ç§’ , è‹¥å›æ‡‰ä¸æ˜¯ 200 liveness æœƒé‡æ–°å•Ÿå‹• Pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: asp-net-core-helloworld-k8s</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: asp-net-core-helloworld-k8s</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: asp-net-core-helloworld-k8s</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: asp-net-core-helloworld-k8s</span><br><span class="line">        image: 10.1.25.123/test/asp-net-core-helloworld-k8s:latest</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: &#x27;/health&#x27;</span><br><span class="line">            port: 5000</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5000</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 500m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 200m</span><br><span class="line">      hostAliases:</span><br><span class="line">      - ip: &quot;10.1.3.5&quot;</span><br><span class="line">        hostnames:</span><br><span class="line">        - &quot;xxooxx&quot;</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: regcred</span><br></pre></td></tr></table></figure>

<p>å…ˆåœ¨ç¨‹å¼ç¢¼è£¡é¢æœ‰æ’ä¸Šé€™æ®µ , æ¸¬è©¦å¯ä»¥ç”¨ <code>curl 10.244.1.29:5000/health</code> å»æˆ³ä»– , ç¾åœ¨æ¯ 10 ç§’ k8s æœƒè‡ªå·±å»æˆ³ , æ­£å¸¸ç‹€æ³æœƒçµ¦ <code>Healthy</code> ç´°éƒ¨å¯ä»¥åœ¨è‡ªå·±ä¾æƒ…å¢ƒèª¿æ•´</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public void Configure(IApplicationBuilder app,</span><br><span class="line">	IWebHostEnvironment env)</span><br><span class="line">&#123;</span><br><span class="line">	//... ç•¥</span><br><span class="line">	app.UseEndpoints( endpoints =&gt;</span><br><span class="line">	 &#123;</span><br><span class="line">		 endpoints.MapControllers();</span><br><span class="line">		 endpoints.MapHealthChecks( &quot;/health&quot; );</span><br><span class="line">	 &#125; );</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç‚ºäº†é©—è­‰æ˜¯å¦æœ‰ç”Ÿæ•ˆå¯ä»¥æ•…æ„æŠŠè·¯å¾‘å¯«éŒ¯ , æ”¹æˆ gg</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">livenessProbe:</span><br><span class="line">  httpGet:</span><br><span class="line">	path: &#x27;/gg&#x27;</span><br><span class="line">	port: 5000</span><br><span class="line">	scheme: HTTP</span><br><span class="line">  initialDelaySeconds: 5</span><br><span class="line">  periodSeconds: 10</span><br></pre></td></tr></table></figure>

<p>æ¥è‘— get po çœ‹çœ‹æœƒä¸æœƒ restart</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k get po -o wide</span><br><span class="line">NAME                                           READY   STATUS         RESTARTS   AGE     IP             NODE              NOMINATED NODE   READINESS GATES</span><br><span class="line">asp-net-core-helloworld-k8s-5d44fff86-4pbbw                    1/1     Running        0          24s     10.244.1.221   node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">asp-net-core-helloworld-k8s-5d44fff86-kwd6w                    1/1     Running        0          24s     10.244.1.222   node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">asp-net-core-helloworld-k8s-5d44fff86-lkr6b                    1/1     Running        4          2m26s   10.244.1.220   node02   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>nlog è¨­å®šè¦æ³¨æ„çš„å•é¡Œäº‹é … , å…ˆè·³é€²å» pod å…§çœ‹çœ‹ , ç™¼ç¾å±…ç„¶æœ‰ D: é€™å€‹è³‡æ–™å¤¾<br>åŸä¾†ä¹‹å‰æœ‰è¨­å®š nlog å¯«å…¥ log æœƒæ”¾åœ¨ D:&#x2F;Log&#x2F;${shortdate}_Now.log , åœ¨ k8s è¨­å®šæ™‚éœ€è¦ç‰¹åˆ¥æ³¨æ„ä¸€ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k exec -it asp-net-core-helloworld-k8s-7c9b78d948-j7mq9 -- /bin/bash</span><br><span class="line">ls</span><br><span class="line">#BouncyCastle.Crypto.dll                         Microsoft.EntityFrameworkCore.dll                    NLog.MailKit.dll                                 System.IdentityModel.Tokens.Jwt.dll</span><br><span class="line">#D:                                              Microsoft.Extensions.DependencyInjection.dll         NLog.Web.AspNetCore.dll                          System.Runtime.Caching.dll</span><br><span class="line">#...ç•¥</span><br></pre></td></tr></table></figure>

<h4 id="Cronjob-Lab"><a href="#Cronjob-Lab" class="headerlink" title="Cronjob Lab"></a>Cronjob Lab</h4><p>æœ‰æ™‚å€™æˆ‘å€‘å¯èƒ½å¸Œæœ›å®šæ™‚åšäº›ä»»å‹™æ¥è‘—å›å ±çµ¦è‡ªå·± , å¯èƒ½ç”¨ line or mail , é€™é‚Šç”¨ curl å»å®šæ™‚æ‰“ä¸€å€‹ api æ¥è‘—ä¸² mail ä¾†é€²è¡Œæ¸¬è©¦ cronjob , é€™è£¡æœ‰å¥½ç”¨çš„ <a target="_blank" rel="noopener" href="https://crontab.guru/">crontab</a>å·¥å…·æ–¹ä¾¿ debug<br>å¦å¤–è¦æ³¨æ„è‡ªå·±çš„æª”æ¡ˆæ˜¯ä»€éº¼æ¬Šé™ , å¯ä»¥åŠ ä¸Š <code>securityContext</code> å€å¡Šä¾†è¨­å®šä½¿ç”¨æ¬Šé™<br>æŸ¥è©¢æ¬Šé™æŒ‡ä»¤å¯ä»¥ç”¨é€™å€‹æŒ‡ä»¤ <code>cat /etc/passwd</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#x:ä½¿ç”¨è€…:ç¾¤çµ„</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æƒ³ç”¨ root çš„è©±å°±è¦è¨­å®šé€™æ¨£</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">securityContext:</span><br><span class="line">	runAsUser: 0</span><br><span class="line">	runAsGroup: 0</span><br></pre></td></tr></table></figure>

<p>æ­¤å¤–æˆ‘å€‘æœ‰ç”¨ <code>hostPath</code> æŠŠè³‡æ–™å¤¾ <code>/home/ladisai/curl_example</code> mount ä¸Šå» , æ³¨æ„ä½¿ç”¨ hostPath æ˜¯æŒ‡åœ¨ node ç¯€é»ä¸Šçš„è³‡æ–™å¤¾ä½ç½® , å¯¦éš›ç”¨çš„è©±æ‡‰è©²æœƒ mount nfs , é€™è£¡å°±å·æ‡¶<br>é‚„æœ‰ä¸€é»è¦ç‰¹åˆ¥å°å¿ƒ , åœ¨ command é€™å€‹åœ°æ–¹è¦åŸ·è¡Œå¤šæ¢çš„è©±éœ€è¦åœ¨ args å…§ä¸€ç›´æ¥ä¸‹å» , å¯ä»¥åƒè€ƒ<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/33887194/how-to-set-multiple-commands-in-one-yaml-file-with-kubernetes">é€™ç¯‡</a></p>
<p>cronjob.yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch/v1</span><br><span class="line">kind: CronJob</span><br><span class="line">metadata:</span><br><span class="line">  name: sendmail</span><br><span class="line">spec:</span><br><span class="line">  schedule: &quot;*/1 * * * *&quot;</span><br><span class="line">  jobTemplate:</span><br><span class="line">    spec:</span><br><span class="line">      template:</span><br><span class="line">        spec:</span><br><span class="line">          containers:</span><br><span class="line">          - name: sendmail</span><br><span class="line">            image: curlimages/curl</span><br><span class="line">            volumeMounts:</span><br><span class="line">            - mountPath: /test</span><br><span class="line">              name: test-volume</span><br><span class="line">            command: [&quot;/bin/sh&quot;]</span><br><span class="line">            args: [</span><br><span class="line">              &quot;-c&quot; ,</span><br><span class="line">              &quot;timestamp=$(date +%s);</span><br><span class="line">              cp /test/mail_template.txt /test/mail_template_$timestamp.txt;</span><br><span class="line">              curl http://10.1.25.123:30612/api/helloworld &gt;&gt; /test/mail_template_$timestamp.txt;</span><br><span class="line">              echo $timestamp &gt;&gt; /test/mail_template_$timestamp.txt;</span><br><span class="line">              curl smtp://email.xxx.com.tw:25 \ --user &#x27;yourname@xxx.com:yourpassword&#x27; \ --mail-from &#x27;yourname@xxx.com&#x27; \ --mail-rcpt &#x27;yourname@xxx.com&#x27; \ --upload-file /test/mail_template_$timestamp.txt&quot;</span><br><span class="line">			]</span><br><span class="line">            #args: [&quot;-c&quot; , &quot;cd /test;pwd &gt;&gt; pwd.txt; cat /test/send_mail_command.sh &gt;&gt; qq.txt&quot;]</span><br><span class="line">            #args: [&quot;-c&quot; , &quot;curl -L www.google.com &gt;&gt; /test/google.txt&quot;]</span><br><span class="line">          securityContext:</span><br><span class="line">            runAsUser: 0</span><br><span class="line">            runAsGroup: 0</span><br><span class="line">          dnsPolicy: ClusterFirstWithHostNet</span><br><span class="line">          dnsConfig:</span><br><span class="line">            nameservers:</span><br><span class="line">              - 10.1.30.5</span><br><span class="line">          volumes:</span><br><span class="line">          - name: test-volume</span><br><span class="line">            hostPath:</span><br><span class="line">              path: /home/yourname/curl_example</span><br><span class="line">          restartPolicy: Never</span><br></pre></td></tr></table></figure>

<p>mail_template.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">From: &quot;yourname&quot; &lt;yourname@xxx.com&gt;</span><br><span class="line">To: &quot;yourname&quot; &lt;yourname@xxx.com&gt;</span><br><span class="line">Subject: This is a test</span><br><span class="line"></span><br><span class="line"> _____</span><br><span class="line">&lt; Log &gt;</span><br><span class="line"> -----</span><br><span class="line">        \   ^__^</span><br><span class="line">         \  (oo)\_______</span><br><span class="line">            (__)\       )\/\</span><br><span class="line">                ||----w |</span><br><span class="line">                ||     ||</span><br></pre></td></tr></table></figure>

<p>æœ€å¾Œçœ‹çœ‹åŸ·è¡Œçµæœ , å¦‚æœæ˜¯ completed æ‰ ok</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">k get cronjob</span><br><span class="line">k get po</span><br></pre></td></tr></table></figure>

<p>é‡åˆ° dns å•é¡Œæˆ–æ˜¯æ¬Šé™å•é¡Œ , å¯ä»¥å…ˆå»ºç«‹ä¸€å€‹ Pod ç”¨é€™æ¨£çš„æ–¹æ³•æ¸¬è©¦çœ‹çœ‹ , é€æ­¥åµéŒ¯ , çœ‹æ˜¯æ¬Šé™ä¸è¶³æˆ–æ˜¯ dns è¨­å®šæœ‰å•é¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: google-curl</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: google-curl</span><br><span class="line">    image: curlimages/curl</span><br><span class="line">    command: [&quot;/bin/sh&quot;]</span><br><span class="line">    args: [&quot;-c&quot; , &quot;echo nameserver 10.1.2.87 &gt;&gt; /etc/resolv.conf; curl -L www.google.com&quot;]</span><br><span class="line">    securityContext:</span><br><span class="line">      runAsUser: 0</span><br><span class="line">      runAsGroup: 0</span><br><span class="line"></span><br><span class="line">#k apply -f google-curl.yaml</span><br><span class="line">#k logs google-curl</span><br></pre></td></tr></table></figure>

<h4 id="nfs-server"><a href="#nfs-server" class="headerlink" title="nfs server"></a>nfs server</h4><p><a target="_blank" rel="noopener" href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nfs-mount-on-ubuntu-20-04">åƒè€ƒè€å¤–</a><br>è·Ÿé€™å€‹<a target="_blank" rel="noopener" href="https://magiclen.org/ubuntu-server-nfs/">å¤§ç¥</a><br>é€™é‚Šç›´æ¥è£åœ¨ master node ä¸Š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#nfs server</span><br><span class="line">sudo apt-get install nfs-kernel-server</span><br><span class="line"></span><br><span class="line">#nfs client</span><br><span class="line">sudo apt-get install nfs-common</span><br><span class="line"></span><br><span class="line">sudo mkdir /var/nfs/general -p</span><br><span class="line">sudo chown nobody:nogroup /var/nfs/general</span><br><span class="line">ls -la /var/nfs/general</span><br><span class="line">sudo chmod -R 777 /var/nfs/general</span><br><span class="line"></span><br><span class="line">#è¨­å®šå¯ä»¥é€£ç·šçš„ client</span><br><span class="line">sudo vim /etc/exports</span><br><span class="line">/var/nfs/general 10.1.25.124(rw,sync,no_subtree_check)</span><br><span class="line"></span><br><span class="line">#restart nfs</span><br><span class="line">sudo systemctl restart nfs-kernel-server</span><br></pre></td></tr></table></figure>

<p>è·³åˆ°å…¶ä»– node åŸ·è¡Œä»¥ä¸‹å‘½ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install nfs-common</span><br><span class="line">sudo mkdir -p /nfs/general</span><br><span class="line"></span><br><span class="line">#æ³¨æ„éå¸¸é‡è¦ , é€™é‚Šè¦ mount master é‚£å° nfs server ä¸è¦å¯«éŒ¯äº†</span><br><span class="line">sudo mount 10.1.25.123:/var/nfs/general /nfs/general</span><br><span class="line">cd /nfs/general</span><br><span class="line"></span><br><span class="line">#æ¸¬è©¦çœ‹çœ‹æ˜¯å¦å¯ä»¥æ­£å¸¸å»ºç«‹æª”æ¡ˆ , ok çš„è©± master &amp; node éƒ½å¯ä»¥çœ‹åˆ°</span><br><span class="line">echo &quot;qq&quot; &gt; qq</span><br><span class="line">cat qq</span><br></pre></td></tr></table></figure>


<h4 id="å®‰è£-Nginx-Ingress-Controller"><a href="#å®‰è£-Nginx-Ingress-Controller" class="headerlink" title="å®‰è£ Nginx Ingress Controller"></a>å®‰è£ Nginx Ingress Controller</h4><p>é è¨­æƒ…æ³ä¸‹ k8s ä¸æœƒå¹«ä½ å®‰è£ ingress controller , éœ€ä¸€è‡ªå·±å®‰è£<br><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">å®˜ç¶²æœ‰å¤šç¨®é¸æ“‡</a><br>å› ç‚ºæœ‰é¸æ“‡éšœç¤™é€™é‚Šç”¨ nginx ingress controller åƒè€ƒ<a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/deploy/#docker-desktop">å®˜ç¶²</a><br>æ­¤å¤–ç”±æ–¼é è¨­ç‚º <code>LoadBalancer</code> , å…§éƒ¨ç’°å¢ƒæœ€å¥½æ”¹ç‚º <code>NodePort</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.47.0/deploy/static/provider/cloud/deploy.yaml</span><br><span class="line"></span><br><span class="line">vim deploy.yaml</span><br><span class="line">#æœå°‹ LoadBalancer</span><br><span class="line">#/LoadBalancer</span><br><span class="line"></span><br><span class="line">#ä¿®æ”¹ç‚º NodePort</span><br><span class="line">#spec:</span><br><span class="line">#  type: NodePort</span><br><span class="line">#  externalTrafficPolicy: Local</span><br><span class="line"></span><br><span class="line">k apply -f deploy.yaml</span><br></pre></td></tr></table></figure>

<p>å®‰è£æœƒå¤šåŠ ä¸Šä¸€å€‹ namespace</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">k get ns</span><br><span class="line">#NAME              STATUS   AGE</span><br><span class="line">#default           Active   35d</span><br><span class="line">#development       Active   14d</span><br><span class="line">#foo               Active   22d</span><br><span class="line">#ingress-nginx     Active   7m43s</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥è¦æ’ˆçš„è©±è¨˜å¾—å¤šåŠ åƒæ•¸ <code>-n ingress-nginx</code> , æˆ–æ˜¯ç›´æ¥ç”¨ <code>-A</code> æ’ˆå…¨éƒ¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">k get svc -n ingress-nginx</span><br><span class="line">k get po -n ingress-nginx</span><br><span class="line">k get svc -A</span><br><span class="line">k get po -A</span><br></pre></td></tr></table></figure>

<p>å®‰è£å¥½ nginx ingress controller å¾Œæœƒå¤šåŠ ä¸Šä¸€å€‹ <code>NodePort</code> ä¾†æœå‹™å°å¤– , å‰›å¥½åˆ†é…åˆ°å¥½é›£è½çš„ port åç¨±</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">k get svc -n ingress-nginx</span><br><span class="line">#NAME                                 TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">#ingress-nginx-controller             LoadBalancer   10.106.114.179   &lt;pending&gt;     80:30678/TCP,443:31326/TCP   13m</span><br><span class="line">#ingress-nginx-controller-admission   ClusterIP      10.104.100.19    &lt;none&gt;        443/TCP                      13m</span><br></pre></td></tr></table></figure>

<p>è£œå…… , å¦‚æœä¸æƒ³è¦å°å¤–å¤šåŠ ä¸Š <code>port 30678</code> é€™éº¼é†œçš„è©±å¯ä»¥è€ƒæ…®æŠŠ <code>hostPort</code> è¨­å®šèµ·ä¾†é€™æ¨£å°±å¯ä»¥ç›´æ¥æ‰“ 80 , 443</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim deploy.yaml</span><br><span class="line">#/Deployment</span><br><span class="line"></span><br><span class="line">#æœå°‹ Deployment æ‰¾åˆ°ä»¥ä¸‹ç‰‡æ®µ</span><br><span class="line">#</span><br><span class="line">#ports:</span><br><span class="line">#  - name: http</span><br><span class="line">#    containerPort: 80</span><br><span class="line">#    hostPort: 80</span><br><span class="line">#    protocol: TCP</span><br><span class="line">#  - name: https</span><br><span class="line">#    containerPort: 443</span><br><span class="line">#    hostPort: 443</span><br></pre></td></tr></table></figure>

<p>æ¥è‘—çœ‹ nginx-controller è¢«åˆ†é…åˆ°å“ªå€‹ node</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">k get po -o wide -n ingress-nginx</span><br><span class="line">#</span><br><span class="line">NAME                                        READY   STATUS      RESTARTS   AGE   IP             NODE              NOMINATED NODE   READINESS GATES</span><br><span class="line">ingress-nginx-admission-create-sx9f4        0/1     Completed   0          16m   10.244.1.172   node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ingress-nginx-admission-patch-jxfx4         0/1     Completed   1          16m   10.244.1.171   node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ingress-nginx-controller-5b74xc9xx8-dg6k5   1/1     Running     0          16m   10.244.1.173   node02   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>å‡è¨­æˆ‘ node02 çš„ vm ip æ˜¯ <code>10.1.25.124</code> , æ‰€ä»¥ç­‰ç­‰å°±è¦æ‰“ <code>curl 10.1.25.124:30678/ç¶²å€</code> , è©¦æ‰“çœ‹çœ‹æœƒè·³ nginx é é¢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl 10.1.25.124:30678</span><br><span class="line">#&lt;html&gt;</span><br><span class="line">#&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">#&lt;body&gt;</span><br><span class="line">#&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">#&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;</span><br><span class="line">#&lt;/body&gt;</span><br><span class="line">#&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>æ¥è‘—æŠŠä¹‹å‰çš„ nodeport ä¿®æ”¹ä¸€ä¸‹è®“ä»–å›ºå®šåœ¨ port 30345<br>asp-net-core-helloworld-k8s-service.yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">    name: asp-net-core-helloworld-k8s</span><br><span class="line">spec:</span><br><span class="line">    type: NodePort</span><br><span class="line">    ports:</span><br><span class="line">    - port: 80 #service çš„ port</span><br><span class="line">      targetPort: 80 # .net core app çš„ port</span><br><span class="line">      nodePort: 30345 #å¤–éƒ¨çš„ port</span><br><span class="line">    selector:</span><br><span class="line">        app: asp-net-core-helloworld-k8s</span><br></pre></td></tr></table></figure>

<p>å…ˆç”¨ curl æ¸¬çœ‹çœ‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl 10.96.165.130/api/helloworld</span><br><span class="line">#Host Name of machine =asp-net-core-helloworld-k8s-5766cd7cc5-js4sj</span><br><span class="line">#IPv4 of Machine is</span><br><span class="line">#10.244.1.119</span><br><span class="line">#IPv6 of Machine is</span><br></pre></td></tr></table></figure>

<p>ç¢ºå®šéƒ½ ok ä»¥å¾Œ , å¯ä»¥åŠ å…¥ ingress çš„è³‡æº (èˆŠç‰ˆ extensions&#x2F;v1beta1) , ç‰¹åˆ¥æ³¨æ„é€™ç¨®å®šç¾©æ–¹å¼éœ€è¦ path å®Œå…¨ match å¦å‰‡æœƒæ‰¾ä¸åˆ°<br>asp-net-core-helloworld-k8s-ingress.yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: asp-net-core-helloworld-k8s</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: asp-net-core-helloworld-k8s.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /api/helloworld #æ³¨æ„é€™é‚Šè¦è·Ÿ app å…§çš„è·¯å¾‘å®Œå…¨ä¸€æ¨£</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: asp-net-core-helloworld-k8s</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹ &#x2F;etc&#x2F;hosts , è‹¥æ˜¯æƒ³åœ¨ windows ä¸Šçœ‹çš„è©±ä½ç½®åœ¨ <code>C:\Windows\System32\drivers\etc\hosts</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">#10.1.25.124 asp-net-core-helloworld-k8s.com</span><br><span class="line"></span><br><span class="line">#ä¸‹é¢ example æœƒç”¨åˆ°</span><br><span class="line">#10.1.25.124 helloworld-k8s.com</span><br><span class="line">#10.1.25.124 helloworld-contour-k8s.com</span><br></pre></td></tr></table></figure>

<p>æœ€å¾Œç”¨ curl æ¸¬è©¦ä¸€ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl asp-net-core-helloworld-k8s.com:30678/api/helloworld</span><br></pre></td></tr></table></figure>

<p>æœ€å¾Œç”¨æ–°ç‰ˆçš„ api æ¸¬è©¦çœ‹çœ‹ (æ–°ç‰ˆ networking.k8s.io&#x2F;v1) , é€™æ¨£å®šç¾©çš„è©±å³å¯è®“å…¨éƒ¨çš„è·¯å¾‘ mapping åˆ°ä½ çš„ url<br>è©³ç´°å¯ä»¥åƒè€ƒ<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/ingress/">å®˜ç¶²</a><br>asp-net-core-helloworld-k8s-ingress-new.yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: asp-net-core-helloworld-k8s-new</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: &quot;nginx&quot;</span><br><span class="line">    nginx.ingress.kubernetes.io/rewrite-target: /</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: helloworld-k8s.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        pathType: Prefix</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: asp-net-core-helloworld-k8s</span><br><span class="line">            port:</span><br><span class="line">              number: 80</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥ç”¨é€™å…©å€‹é é¢æ¸¬è©¦<br><a target="_blank" rel="noopener" href="http://helloworld-k8s.com:30678/swagger/index.html">http://helloworld-k8s.com:30678/swagger/index.html</a><br><a target="_blank" rel="noopener" href="http://helloworld-k8s.com:30678/api/helloworld">http://helloworld-k8s.com:30678/api/helloworld</a></p>
<p>æœ€å¾Œè£œå…… nginx ingress controller æœƒåœ¨ <code>/etc/nginx/nginx.conf</code> è£œä¸Šèˆ‡å‰›å‰›è¨­å®šçš„ helloworld-k8s.com , å¯ä»¥è·³é€²å»çœ‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">k exec -it ingress-nginx-controller-5b74bxx868-lg47d -n ingress-nginx -- bash</span><br><span class="line">#cat /etc/nginx/nginx.conf</span><br><span class="line">#vi /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>


<h3 id="Helm-å®‰è£-åƒè€ƒå®˜ç¶²"><a href="#Helm-å®‰è£-åƒè€ƒå®˜ç¶²" class="headerlink" title="Helm å®‰è£ , åƒè€ƒå®˜ç¶²"></a>Helm å®‰è£ , åƒè€ƒ<a target="_blank" rel="noopener" href="https://helm.sh/docs/intro/install/">å®˜ç¶²</a></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl https://baltocdn.com/helm/signing.asc | sudo apt-key add -</span><br><span class="line">sudo apt-get install apt-transport-https --yes</span><br><span class="line">echo &quot;deb https://baltocdn.com/helm/stable/debian/ all main&quot; | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install helm</span><br></pre></td></tr></table></figure>

<h3 id="å…¶ä»–æ“ä½œä¸Šçš„å°æŠ€å·§"><a href="#å…¶ä»–æ“ä½œä¸Šçš„å°æŠ€å·§" class="headerlink" title="å…¶ä»–æ“ä½œä¸Šçš„å°æŠ€å·§"></a>å…¶ä»–æ“ä½œä¸Šçš„å°æŠ€å·§</h3><p>é€™è£¡å®šç¾© <code>${VERSION}</code> ç•¶ä½œè®Šæ•¸ , ä¸¦ä¸”å®šç¾© template.yaml , å¯ä»¥æ¥ä¸Š <code>envsubst</code> å¿«é€Ÿæ›¿æ›å…§å®¹ä¾†é€²è¡Œæ›´ç‰ˆ<br>å¦å¤–æ³¨æ„åˆ° <code>--record</code> åƒæ•¸ , å¯ä»¥æ›´è©³ç´°è¨˜éŒ„ç•¶æ™‚çš„æŒ‡ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VERSION=&#x27;v1.0&#x27; envsubst &lt; template.yaml | k apply --record -f -</span><br></pre></td></tr></table></figure>

<p>template.yaml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: asp-net-core-helloworld-k8s</span><br><span class="line">spec:</span><br><span class="line">  replicas: 4</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: asp-net-core-helloworld-k8s</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: asp-net-core-helloworld-k8s</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: asp-net-core-helloworld-k8s</span><br><span class="line">        image: 10.1.25.123/test/helloworldk8s:$&#123;VERSION&#125;</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">        - containerPort: 443</span><br><span class="line">        env:</span><br><span class="line">        - name: ASPNETCORE_URLS</span><br><span class="line">          value: http://+:80;https://+:443</span><br><span class="line">        - name: ASPNETCORE_ENVIRONMENT</span><br><span class="line">          value: Development</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: regcred</span><br></pre></td></tr></table></figure>

<p>apply ä»¥å¾Œå¯ä»¥ç”¨ä»¥ä¸‹æŒ‡ä»¤å»æŸ¥ç›®å‰æ›´æ–°ç‹€æ…‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k rollout status deployment asp-net-core-helloworld-k8s</span><br></pre></td></tr></table></figure>

<p>åˆ—å°å‡ºä¿®æ”¹æ­·å²</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k rollout history deployment asp-net-core-helloworld-k8s</span><br></pre></td></tr></table></figure>

<p>æ»¾å›ä¹‹å‰çš„ç‰ˆæœ¬</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#æ»¾å›ä¸Šå€‹ç‰ˆæœ¬</span><br><span class="line">k rollout undo deployment asp-net-core-helloworld-k8s</span><br><span class="line"></span><br><span class="line">#æ»¾å›ç‰¹å®šçš„ç‰ˆæœ¬</span><br><span class="line">k rollout undo deployment asp-net-core-helloworld-k8s --to-revision 5</span><br></pre></td></tr></table></figure>

<p>é‡‘çµ²é›€ä½ˆç½²å› ç‚ºåªå¤šåŠ ä¸€å€‹æ–°ç‰ˆçš„ pod , æ‰€ä»¥å¯ä»¥ç”¨æš«åœå‘½ä»¤ä¾†ä¸²</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VERSION=&#x27;v1.1&#x27; envsubst &lt; template.yaml | k apply --record -f - &amp;&amp; \</span><br><span class="line">k rollout pause deployment asp-net-core-helloworld-k8s</span><br></pre></td></tr></table></figure>


<p>Here Document é€™å€‹æŠ€å·§å¯ä»¥ç›´æ¥åœ¨ command å…§å¿«é€ŸåŠ ä¸Šæƒ³è£œçš„å…§å®¹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27;cat &lt;&lt;EOF &gt; /etc/resolv.conf</span><br><span class="line">nameserver 8.8.8.8</span><br><span class="line">EOF&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="å…¶ä»–è£œå……"><a href="#å…¶ä»–è£œå……" class="headerlink" title="å…¶ä»–è£œå……"></a>å…¶ä»–è£œå……</h3><p>ç·¨è¼¯æ±è¥¿å‰å‹™å¿…çŸ¥é“çš„<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/kubernetes-api/workload-resources/pod-v1/">å®˜ç¶²èªªæ˜</a></p>
<p>è·³é€²å»çœ‹çœ‹ç’°å¢ƒè®Šæ•¸</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">exec -it asp-net-core-helloworld-k8s-5766cd7cc5-js4sj -- /bin/bash</span><br><span class="line">env | grep ASPNETCORE_URLS</span><br></pre></td></tr></table></figure>

<p>é–‹å•Ÿ chrome æ¸¬è©¦é€™é‚Šè¦æ”¹æˆç”¨ curl æ¸¬è©¦ , å› ç‚º chrome æœƒç”¨ keep-alive é€£ç·š , è€Œ curl æ¯æ¬¡éƒ½æœƒé–‹ä¸€å€‹æ–°çš„é€£ç·š</p>
<p>å¦‚æœæƒ³è®“æ¯å€‹ç›¸åŒ client ip éƒ½è½‰åˆ°åŒå€‹ pod ä¸Šçš„è©±å¯ä»¥é–‹å•Ÿé€™å€‹é¸é …</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">spec:</span><br><span class="line">	sessionAffinity: ClientIP</span><br></pre></td></tr></table></figure>



    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/docker/" rel="tag"># docker</a>
              <a href="/tags/k8s/" rel="tag"># k8s</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/jquery-%E5%B8%B8%E8%A6%8B%E7%9A%84%E4%BD%8E%E8%83%BD%E5%95%8F%E9%A1%8C/" rel="prev" title="jquery å¸¸è¦‹çš„ä½èƒ½å•é¡Œ">
      <i class="fa fa-chevron-left"></i> jquery å¸¸è¦‹çš„ä½èƒ½å•é¡Œ
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/k8s-%E5%AE%89%E8%A3%9D%E7%AD%86%E8%A8%98/" rel="next" title="k8s å®‰è£ç­†è¨˜">
      k8s å®‰è£ç­†è¨˜ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®éŒ„
        </li>
        <li class="sidebar-nav-overview">
          æœ¬ç«™æ¦‚è¦
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Harbor-%E5%AE%89%E8%A3%9D"><span class="nav-number">1.</span> <span class="nav-text">Harbor å®‰è£</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s-%E6%95%B4%E5%90%88"><span class="nav-number">2.</span> <span class="nav-text">k8s æ•´åˆ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s-%E6%95%B4%E5%90%88-net-core"><span class="nav-number">3.</span> <span class="nav-text">k8s æ•´åˆ .net core</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Pod-%E8%B5%B7%E6%89%8B%E5%BC%8F"><span class="nav-number">3.1.</span> <span class="nav-text">Pod èµ·æ‰‹å¼</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Deployment-Lab"><span class="nav-number">3.2.</span> <span class="nav-text">Deployment Lab</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HPA-Lab"><span class="nav-number">3.3.</span> <span class="nav-text">HPA Lab</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A8%AD%E5%AE%9A-dns"><span class="nav-number">3.4.</span> <span class="nav-text">è¨­å®š dns</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#hosts-%E8%A8%AD%E5%AE%9A"><span class="nav-number">3.5.</span> <span class="nav-text">hosts è¨­å®š</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#liveness-%E6%8E%A2%E9%87%9D"><span class="nav-number">3.6.</span> <span class="nav-text">liveness æ¢é‡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Cronjob-Lab"><span class="nav-number">3.7.</span> <span class="nav-text">Cronjob Lab</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#nfs-server"><span class="nav-number">3.8.</span> <span class="nav-text">nfs server</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%9D-Nginx-Ingress-Controller"><span class="nav-number">3.9.</span> <span class="nav-text">å®‰è£ Nginx Ingress Controller</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Helm-%E5%AE%89%E8%A3%9D-%E5%8F%83%E8%80%83%E5%AE%98%E7%B6%B2"><span class="nav-number">4.</span> <span class="nav-text">Helm å®‰è£ , åƒè€ƒå®˜ç¶²</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E6%93%8D%E4%BD%9C%E4%B8%8A%E7%9A%84%E5%B0%8F%E6%8A%80%E5%B7%A7"><span class="nav-number">5.</span> <span class="nav-text">å…¶ä»–æ“ä½œä¸Šçš„å°æŠ€å·§</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E8%A3%9C%E5%85%85"><span class="nav-number">6.</span> <span class="nav-text">å…¶ä»–è£œå……</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ğŸŒ¹ å–‡è³½äºº ğŸŒ¹"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">ğŸŒ¹ å–‡è³½äºº ğŸŒ¹</p>
  <div class="site-description" itemprop="description">ğŸŒ¹ å–‡è³½äººçš„ Blog ğŸŒ¹</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">341</span>
          <span class="site-state-item-name">æ–‡ç« </span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">æ¨™ç±¤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/weber87na" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;weber87na" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

	  <!-- skilltree å»£å‘Š -->
	  <div id="myadblock" style="margin-top:25px;position:relative">
	  <div id="myadblock-title" style="position:absolute;left:-10px;top:-10px;width:100px;background-color:rgba(0,0,0,.75);color:white;">å·æ”¾å·¥å•†</div>
	  <script src="https://skilltree.my/promotion/cec9b4b0-be5e-4727-85c6-f7af5445124a?w=350"></script>
	  </div>

	  <!-- google å»£å‘Š -->
	  <!--
	  <ins class="adsbygoogle"
		  style="display:inline-block;width:220px;height:120px;margin-top:50px;position:relative;border-bottom-left-radius: 15px 255px;border-bottom-right-radius: 225px 15px;border-top-left-radius: 255px 15px;border-top-right-radius: 15px 225px;border: 2px solid #41403e;"
		  data-ad-client="ca-pub-1069539516107706"
		  data-ad-slot="6588270137">
	  <div id="myadblock-title2" style="z-index:999999;position:absolute;left:-10px;top:-10px;width:100px;background-color:rgba(0,0,0,.75);color:white;">å·æ”¾å·¥å•†</div>
	  </ins>
	  <script>
		  (adsbygoogle = window.adsbygoogle || []).push({});
	  </script>
	  -->

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">å–‡è³½çš„äºº! G__G+</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">ç¸½å»¢è©±å­—æ•¸ï¼š</span>
    <span title="ç¸½å»¢è©±å­—æ•¸">1.7m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">æ‰€éœ€ç¸½æµªè²»æ™‚é–“ &asymp;</span>
    <span title="æ‰€éœ€ç¸½æµªè²»æ™‚é–“">25:58</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://la-sai-de-ren.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://www.blog.lasai.com.tw/posts/Harbor-%E5%BB%BA%E7%AB%8B%E7%A7%81%E6%9C%89-docker-registry/";
    this.page.identifier = "posts/Harbor-å»ºç«‹ç§æœ‰-docker-registry/";
    this.page.title = "Harbor å»ºç«‹ç§æœ‰ docker registry";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://la-sai-de-ren.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>


  <!-- <div class="snow1" style="position:fixed !important"></div> -->
  <div class="cobweb" style="position:fixed !important"></div>
  <div class="spider" style="position:fixed !important"></div>
<div class="fswitch">é—œé–‰</div>
<div class="snowflakes" aria-hidden="true">
  <div class="snowflake">
 ğŸŒ¹
  </div>
  <div class="snowflake">
 ğŸ’©
  </div>
  <div class="snowflake">
 ğŸŒ¹
  </div>
  <div class="snowflake">
 ğŸ’©
  </div>
    <div class="snowflake">
 ğŸŒ¹
  </div>
  <div class="snowflake">
 ğŸ’©
  </div>
    <div class="snowflake">
 ğŸŒ¹
  </div>
  <div class="snowflake">
 ğŸ’©
  </div>
</div>

<!--
<script>
	function toggleSpell() {
		let spell = document.getElementsByClassName('spell')[0];
		let ghost = document.getElementsByClassName('ghost')[0];
		let noise = document.getElementsByClassName('noise')[0];
		let noise2 = document.getElementsByClassName('noise2')[0];
		if (spell.style.display === 'none') {
			spell.style.display = 'block';
			noise.style.display = '';
			noise2.style.display = '';
			ghost.style.display = 'none';
		} else {
			spell.style.display = 'none';
			noise.style.display = 'none';
			noise2.style.display = 'none';
			ghost.style.display = 'block';
		}
	}

	//è¨‚é–±å…§å®¹
	let spell = document.getElementsByClassName('spell')[0];
	let ghost = document.getElementsByClassName('ghost')[0];
	spell.addEventListener('click',toggleSpell);
	ghost.addEventListener('click',toggleSpell);
</script>
-->

<script>

let cobweb = document.querySelector('.cobweb');
let spider = document.querySelector('.spider');
let back = document.querySelector('.back-to-top');
let fswitch = document.querySelector('.fswitch');

document.addEventListener('keydown', function(event) {
	if (event.key === 'f') {
		console.log('press f key');
		ftoggle();
	}
});

fswitch.addEventListener('click' , function(){ 
	ftoggle();
});

function ftoggle(){
	if(cobweb.style.display === ''){
		cobweb.style.display = 'none';
	}else{
		cobweb.style.display = '';
	}
	if(spider.style.display === ''){
		spider.style.display = 'none';
	}else{
		spider.style.display = '';
	}
	if(back.style.display === ''){
		back.style.display = 'none';
	}else{
		back.style.display = '';
	}

	if(fswitch.innerText === 'é—œé–‰') fswitch.innerText = 'ä¹–ä¹–'
	else fswitch.innerText = 'é—œé–‰'
}



</script>

<script>
class ViNavigation {
  constructor() {
    this.Mode = {
      Normal: "normal",
      Motion: "motion",
    };

    this.lastKeyPressTime = 0;
    this.lastKeyPressed = "";
    this.currentMode = this.Mode.Normal;

    //å¯ä½¿ç”¨ç§»å‹•çš„å­—ç¢¼
    //å…± 18 å€‹å­— æ’é™¤ vi æœƒç”¨åˆ°çš„å­—
    this.tagChars = "ABCEILNOPQRSTVWXYZ";

    //ç›®å‰çš„ vim æ¨™ç¤ºå­—æ¨™ç±¤ array
    this.holdTags = new Array();

    //é å…ˆå»ºç«‹å…©å­—çµ„åˆçš„å­—å…¸
    this.dict = new Array();
    //é›™å±¤è¿´åœˆçŒå…¥æ‰€æœ‰å…©å­—çµ„åˆ
    for (var i = 0; i < this.tagChars.length; i++) {
      for (var j = 0; j < this.tagChars.length; j++) {
        this.dict.push(this.tagChars[i] + this.tagChars[j]);
      }
    }
  }

  viGoTop(keyPressed) {
    if (keyPressed === "g") {
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  }

  viGoBottom(keyPressed) {
    if (keyPressed === "G") {
      console.log("document.body.scrollHeight", document.body.scrollHeight);
      let h = Math.max(
        Math.max(
          document.body.scrollHeight,
          document.documentElement.scrollHeight
        ),
        Math.max(
          document.body.offsetHeight,
          document.documentElement.offsetHeight
        ),
        Math.max(
          document.body.clientHeight,
          document.documentElement.clientHeight
        )
      );
      window.scrollTo({ top: h, behavior: "smooth" });
    }
  }

  viFastDown(keyPressed) {
    if (keyPressed === "d") {
      this.move(350);
    }
  }

  viDown(keyPressed) {
    if (keyPressed === "j") {
      this.move(100);
    }
  }

  viFastUp(keyPressed) {
    if (keyPressed === "u") {
      this.move(-350);
    }
  }

  viUp(keyPressed) {
    if (keyPressed === "k") {
      this.move(-100);
    }
  }

  move(val) {
    var currentPosition =
      window.pageYOffset || document.documentElement.scrollTop;
    window.scrollTo({
      top: currentPosition + val,
      behavior: "smooth",
    });
  }

  removeViTags() {
    let allTags = document.querySelectorAll(".vim-tag");
    allTags.forEach(function (tag) {
      tag.parentNode.removeChild(tag);
    });
  }

  createViTag(text, href, top, left) {
    let newDiv = document.createElement("div");
    newDiv.classList.add("vim-tag");
    newDiv.style.fontFamily = "Arial, sans-serif";
    newDiv.style.fontSize = "12px";
    newDiv.style.position = "absolute";
    newDiv.style.backgroundColor = "#89CF07";
    newDiv.style.color = "black";
    newDiv.style.padding = "2px";
    newDiv.style.borderRadius = "2px";
    newDiv.style.zIndex = "999999";

    newDiv.textContent = text;
    newDiv.dataset.href = href;
    newDiv.style.top = top;
    newDiv.style.left = left;
    return newDiv;
  }

  createViTags() {
    let allTags = document.querySelectorAll("a");
    let counter = 0;
    for (let tag of allTags) {
      let rect = tag.getBoundingClientRect();
      let href = tag.href;
      //é€™å€‹è·é›¢éœ€è¦åŠ å…¥å·è»¸è·é›¢æ‰æœƒæ­£ç¢º
      let top = window.scrollY + rect.top + "px";
      let left = window.scrollX + rect.left + "px";
      let text = "";
      if (allTags.length <= this.tagChars.length) {
        text = this.tagChars[counter];
        this.holdTags.push(text);
      } else {
        text = this.dict[counter];
        this.holdTags.push(text);
      }
      let newDiv = this.createViTag(text, href, top, left);
      document.body.appendChild(newDiv);
      counter++;
    }
  }

  //æ‰¾å‡ºç›®å‰çš„é¦–å­— array
  firstCharArray() {
    let result = [];
    for (let i = 0; i < this.holdTags.length; i++) {
      let text = this.holdTags[i];
      if (text) {
        let theChar = text[0].toLowerCase();
        if (result.includes(theChar) === false) {
          result.push(theChar);
        }
      }
    }

    return result;
  }

  toggleMotion() {
    this.currentMode = this.Mode.Motion;
    this.lastKeyPressed = "";
    console.log("mode", this.currentMode);
    this.createViTags();
  }

  toggleNormal() {
    this.currentMode = this.Mode.Normal;
    console.log("mode", this.currentMode);
    this.removeViTags();
    this.holdTags = [];
    this.lastKeyPressed = "";
  }

  handleKeyDown(event) {
    let currentTime = new Date().getTime();
    let keyPressed = event.key;

    //æŒ‰ä¸‹ F æ™‚é€²å…¥ motion æ¨¡å¼
    if (this.currentMode === this.Mode.Normal && keyPressed === "F") {
      this.toggleMotion();
      return;
    }

    //æŒ‰ä¸‹ esc è·³é›¢ motion æ¨¡å¼å›åˆ° normal æ¨¡å¼
    if (this.currentMode === this.Mode.Motion && keyPressed === "Escape") {
      this.toggleNormal();
      return;
    }

    //ç•¶ motion ä¸€å€‹å­—æ™‚æ‰èµ°é€™æ¨¡å¼
    if (
      this.currentMode === this.Mode.Motion &&
      document.querySelectorAll("a").length <= this.tagChars.length &&
      this.tagChars.toLowerCase().includes(keyPressed)
    ) {
      console.log("one char mode");
      let allTags = document.querySelectorAll(".vim-tag");

      allTags.forEach(function (tag) {
        if (tag.textContent.toLowerCase() === keyPressed) {
          window.location.href = tag.dataset.href;
        }
      });

      this.toggleNormal();
      return;
    }

    //ç•¶ motion å…©å€‹å­—æ‰èµ°é€™å€‹æ¨¡å¼
    if (
      this.currentMode === this.Mode.Motion &&
      document.querySelectorAll("a").length > this.tagChars.length
    ) {
      console.log("motion lastKeyPressed", this.lastKeyPressed);
      console.log("motion current", keyPressed);

      if (!this.lastKeyPressed) {
        //å¦‚æœå‡ºç¾å­—è¡¨ä»¥å¤–çš„å­—å‰‡å›åˆ° normal
        //console.log("firstCharArray", this.firstCharArray());
        if (this.firstCharArray().includes(keyPressed) === false) {
          this.toggleNormal();
          return;
        } else {
          let allTags = document.querySelectorAll(".vim-tag");
          allTags.forEach(function (tag) {
            if (tag.textContent[0].toLowerCase() !== keyPressed) {
              tag.parentNode.removeChild(tag);
            }

            //å°‡ç¬¬ä¸€å€‹å­—è®Šç‚ºç´…è‰²
            if (tag.textContent[0].toLowerCase() === keyPressed) {
              tag.innerHTML =
                '<span style="color: red;">' +
                tag.textContent.charAt(0) +
                "</span>" +
                tag.textContent.substring(1);
            }
          });
        }
      }

      //å¦‚æœæœ‰å­—çš„è©±æ‰åŸ·è¡Œ
      if (this.lastKeyPressed) {
        let chars = this.lastKeyPressed + keyPressed;
        console.log("chars", chars);
        let allTags = document.querySelectorAll(".vim-tag");
        allTags.forEach(function (tag) {
          if (tag.textContent.toLowerCase() === chars) {
            window.location.href = tag.dataset.href;
          }
        });
        //è¬ä¸€æ²’æ‰¾åˆ°åˆ‡å› Normal
        this.toggleNormal();
        return;
      }
    }

    // ä»»ä½•æ¨¡å¼æŒ‰å…©ä¸‹çš„å€åŸŸ
    if (
      keyPressed === this.lastKeyPressed &&
      currentTime - this.lastKeyPressTime < 300
    ) {
      this.viGoTop(keyPressed);
    }

    // æŒ‰ä¸€ä¸‹çš„å€åŸŸ
    this.viGoBottom(keyPressed);
    this.viDown(keyPressed);
    this.viFastDown(keyPressed);
    this.viUp(keyPressed);
    this.viFastUp(keyPressed);

    this.lastKeyPressTime = currentTime;
    this.lastKeyPressed = keyPressed;
  }

  init() {
    document.addEventListener("keydown", this.handleKeyDown.bind(this));
  }
}

const viNavigation = new ViNavigation();
viNavigation.init();
</script>



</body>
</html>
